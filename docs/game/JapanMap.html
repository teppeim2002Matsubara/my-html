<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>都道府県バトル（リアルタイム）</title>
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif; }
    header { display:flex; gap:12px; align-items:center; padding:10px 14px; box-shadow: 0 1px 0 rgba(0,0,0,.08); position: sticky; top:0; background:#fff; z-index:2; }
    .brand { font-weight:700; }
    .row { display:flex; gap:16px; padding:14px; }
    .col { flex:1; min-width: 280px; }
    fieldset { border:1px solid #e5e7eb; border-radius:12px; padding:12px; }
    legend { padding: 0 6px; color:#374151; }
    label { font-size: 12px; color:#374151; }
    input, button, select { border:1px solid #d1d5db; border-radius:10px; padding:8px 10px; font-size:14px; }
    button { cursor:pointer; }
    button.primary { background:#111827; color:#fff; border-color:#111827; }
    button.ghost { background:#fff; }
    .stack { display:flex; flex-direction: column; gap:8px; }
    .side { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .status { font-size:13px; color:#4b5563; }
    .board { display:flex; gap:16px; align-items:flex-start; }
    .mapwrap { position:relative; border:1px solid #e5e7eb; border-radius:12px; overflow:hidden; background:#f9fafb; }
    #mapContainer { width: 100%; height: 70vh; display:grid; place-items:center; }
    svg { width: 100%; height: 100%; }
    .question { font-size: 18px; font-weight: 700; }
    .highlight-correct { opacity: .9; transition: fill .2s ease; }
    .highlight-wrong { fill: #ef4444 !important; opacity:.9; transition: fill .2s ease; }
    .hoverable { cursor:pointer; }
    .score { font-variant-numeric: tabular-nums; }
    table { border-collapse: collapse; width:100%; }
    th, td { border-bottom:1px solid #e5e7eb; padding:6px 4px; font-size:14px; text-align:left; }
    .hint { font-size: 12px; color:#6b7280; }
    .toast { position: fixed; right: 12px; bottom: 12px; background: #111827; color: #fff; padding: 10px 12px; border-radius: 10px; font-size: 13px; opacity: 0; transform: translateY(10px); transition: all .2s ease; }
    .toast.show { opacity: 1; transform: translateY(0); }
    .pill { display:inline-flex; align-items:center; gap:6px; background:#f3f4f6; color:#111827; border-radius:9999px; padding:4px 8px; font-size:12px; }
    .chip { display:inline-flex; gap:6px; font-size:12px; color:#374151; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .foot { font-size:12px; color:#6b7280; padding: 8px 14px 16px; }
  </style>
</head>
<body>
  <header>
    <div class="brand">🗾 都道府県バトル（リアルタイム）</div>
    <div class="chip">状態: <span id="connState">オフライン</span></div>
    <div class="chip">ルーム: <span id="roomLabel">-</span></div>
    <div class="chip">プレイヤー: <span id="playersCount">0</span></div>
    <div style="margin-left:auto" class="side">
      <button class="ghost" id="soloBtn" title="サーバなしで練習">ソロ練習</button>
      <button class="primary" id="startBtn" disabled>対戦スタート</button>
    </div>
  </header>

  <div class="row">
    <div class="col">
        <legend>参加</legend>
        <div class="side" style="gap:8px;align-items:center;flex-wrap:wrap;">
          <label>名前</label>
          <input id="name" placeholder="例: てっぺい" size="10" />
          <label>色</label>
          <input type="color" id="color" value="#22c55e" title="自分の正解カラー" />
          <label>ルーム</label>
          <input id="room" placeholder="例: meg1" size="8" />
          <button id="joinBtn">入室</button>
        </div>
        <div class="hint">WS サーバ（デフォルト）: <span class="mono" id="wsUrl">wss://calisthenical-migdalia-cousinly.ngrok-free.dev</span></div>
        <div class="side">
          <label>WS URL</label>
          <input id="wsInput" value="wss://calisthenical-migdalia-cousinly.ngrok-free.dev" size="24" />
          <button id="wsApply">適用</button>
        </div>
        <div class="hint">URL に <span class="mono">?room=XXXX&name=YYY</span> を付けてもOK。</div>
      </fieldset>

      <fieldset class="stack" style="margin-top:12px;">
        <legend>地図の読み込み</legend>
        <div class="stack">
          <input type="file" id="svgFile" accept="image/svg+xml" />
          <div class="hint">★ 添付 PDF を <b>SVG に変換</b>（例: Inkscape で “PDF を開く → SVGで保存”）し、ここに読み込ませてください。<br>SVG 内の <span class="mono">&lt;path id="北海道"&gt;</span> のように <b>都道府県名の id</b> を付けると自動で判定します。</div>
          <details>
            <summary>ミニデモ（北海道・沖縄・東京 だけの簡易 SVG を使う）</summary>
            <button id="loadDemo">デモSVGを読み込み</button>
          </details>
        </div>
      </fieldset>

      <fieldset class="stack" style="margin-top:12px;">
        <legend>問題 / スコア</legend>
        <div class="question">Q: <span id="question">（読み込み待ち）</span> <button id="skipBtn" style="margin-left:8px">スキップ▶</button></div>
        <div class="status">ターン: <span id="turn">0</span> / <span id="turnMax">0</span></div>
        <div style="margin-top:8px;">
          <table id="scoreTable">
            <thead><tr><th>プレイヤー</th><th>スコア</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </fieldset>

      <div class="foot">
        出典（地図ベース）: ちびむすドリル塗り絵日本地図（PDF）を利用の上で SVG 化してお使いください。著作権と利用規約にご注意ください。
      </div>
    </div>

    <div class="col board">
      <div class="mapwrap" style="flex:1;">
        <div id="mapContainer"><div class="hint">左の「地図の読み込み」で SVG を読み込んでください。</div></div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
// ============ 小ユーティリティ ==========
const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => Array.from(document.querySelectorAll(sel));
function toast(msg){ const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1200); }
function normName(s){ return (s||'').replace(/\s+/g,'').replace(/[都道府県府 ]/g,''); }
function getDisplayName(el){
  if(!el) return '';
  return (
    el.getAttribute('data-name') ||
    el.getAttribute('aria-label') ||
    el.getAttribute('inkscape:label') ||
    (el.querySelector && el.querySelector('title') && el.querySelector('title').textContent) ||
    el.id || ''
  ).trim();
}

// ============ 状態 ============
let ws=null; let wsUrl = 'wss://calisthenical-migdalia-cousinly.ngrok-free.dev';
let me = { id:null, name:'', room:'', color:'#22c55e' };
let state = {
  mode: 'solo', // 'solo' or 'multi'
  questionList: [],
  turn: 0,
  turnMax: 10,
  current: null,
  scores: {},
  clickable: true,
  svgDoc: null,
  prefectures: []
};

function updateButtons(){ const ok = state.prefectures.length && (state.mode==='solo' || (ws && ws.readyState===1)); const sb = document.querySelector('#startBtn'); if(sb) sb.disabled = !ok; }

// ============ サーバ通信（WebSocket） ============
function connect(){ if(ws){ try{ ws.close(); }catch(_){} }
  ws = new WebSocket(wsUrl);
  ws.onopen = ()=>{ $('#connState').textContent = 'オンライン'; if(me.room&&me.name){ send({type:'join', room:me.room, name:me.name, color: me.color}); } };
  ws.onclose = ()=>{ $('#connState').textContent = 'オフライン'; };
  ws.onerror = ()=>{ $('#connState').textContent = 'エラー'; };
  ws.onmessage = (ev)=>{
    const msg = JSON.parse(ev.data);
    switch(msg.type){
      case 'joined': me.id = msg.id; $('#playersCount').textContent = msg.players; state.scores = msg.scores || {}; renderScores(); break;
      case 'players': $('#playersCount').textContent = msg.players; state.scores = msg.scores || {}; renderScores(); break;
      case 'start': state.mode='multi'; state.questionList = msg.questions; state.turn=0; state.turnMax = msg.questions.length; nextQuestion(); $('#turnMax').textContent = state.turnMax; break;
      case 'click-result': showClickResult(msg); break;
      case 'advance': state.turn = msg.turn; setQuestion(msg.question); break;
      case 'scores': state.scores = msg.scores||{}; renderScores(); break;
    }
  };
}
function send(o){ if(ws && ws.readyState===1) ws.send(JSON.stringify(o)); }

// ============ ゲーム ============
function setQuestion(name){ state.current = name; $('#question').textContent = name; }
function nextQuestion(){
  if(state.turn >= state.turnMax){ $('#question').textContent = '終了！'; state.clickable=false; return; }
  const q = state.questionList[state.turn]; setQuestion(q); $('#turn').textContent = (state.turn+1);
}
function startSolo(){
  state.mode='solo'; if(!state.prefectures.length){ toast('先にSVGを読み込んでください'); return; }
  const prefNames = [ '北海道','青森県','岩手県','宮城県','秋田県','山形県','福島県','茨城県','栃木県','群馬県','埼玉県','千葉県','東京都','神奈川県','新潟県','富山県','石川県','福井県','山梨県','長野県','岐阜県','静岡県','愛知県','三重県','滋賀県','京都府','大阪府','兵庫県','奈良県','和歌山県','鳥取県','島根県','岡山県','広島県','山口県','徳島県','香川県','愛媛県','高知県','福岡県','佐賀県','長崎県','熊本県','大分県','宮崎県','鹿児島県','沖縄県' ];
  const prefSet = new Set(prefNames.map(n=>normName(n)));
  const names = state.prefectures
    .map(el=>getDisplayName(el))
    .filter(n=>prefSet.has(normName(n)));
  state.questionList = shuffle(names).slice(0, Math.min(10, names.length));
  state.turn=0; state.turnMax=state.questionList.length; $('#turnMax').textContent = state.turnMax; state.scores = {}; renderScores();
  highlightClear(); state.clickable=true; nextQuestion(); updateButtons();
}
function startMulti(){
 send({type:'start', room: me.room}); }

function onMapClick(target){
  if(!state.clickable || !state.current) return; if(!target) return;
  const clickedId = (target.id||'').trim();
  const clickedName = getDisplayName(target);
  if(!clickedId && !clickedName){ toast('この要素に id/名前 がありません'); return; }
  const good = normName(clickedName) === normName(state.current);
  if(state.mode==='solo'){
    if(good){ highlight(target, me.color||'#22c55e'); toast('正解！'); state.turn++; nextQuestion(); }
    else { flashWrong(target); toast('ちがうよ'); }
  } else {
    send({ type:'click', room: me.room, id: me.id, name: me.name, color: me.color, // 互換性のため全部送る
      answer: clickedName, answerName: clickedName, answerId: clickedId });
  }
}


function showClickResult(msg){
  let el = null;
  if(msg.clickedId){ el = state.svgDoc.getElementById(msg.clickedId); }
  // 旧サーバ互換: clickedId が無い場合、answer(=名前)で要素を推定
  if(!el && msg.answer){
    const targetName = msg.answer;
    el = state.prefectures.find(node => normName(getDisplayName(node)) === normName(targetName));
  }
  if(!el) return;
  if(msg.correct){ highlight(el, msg.color || '#22c55e'); }
  else { flashWrong(el); }
  if(msg.next){ state.turn = msg.turn; setQuestion(msg.next); $('#turn').textContent = (state.turn+1); }
}

// ============ SVG 取扱い ============
function attachHandlersToSVG(root){
  // クリックターゲット: path, polygon, rect, g（id 保持）
  const sels=['path','polygon','rect','g'];
  const els = [];
  sels.forEach(s=> root.querySelectorAll(s).forEach(el=>{ if(el.id){ els.push(el); el.classList.add('hoverable'); el.addEventListener('click', (e)=>{ e.stopPropagation(); onMapClick(el); }, false); } }));
  state.prefectures = els;
}

function highlight(el, color){ el.classList.remove('highlight-wrong'); if(color){ el.style.fill = color; } el.classList.add('highlight-correct'); }
function highlightClear(){
  state.prefectures.forEach(el=>{
    el.classList.remove('highlight-correct','highlight-wrong');
    el.style.fill='';
  });
}
function flashWrong(el){ el.classList.add('highlight-wrong'); setTimeout(()=>el.classList.remove('highlight-wrong'), 600); }
function shuffle(a){ const arr=[...a]; for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }

// ============ UI 初期化 ============
$('#wsApply').onclick = ()=>{ const v=$('#wsInput').value.trim(); if(v){ wsUrl=v; $('#wsUrl').textContent=v; connect(); }};
$('#joinBtn').onclick = ()=>{ me.name=$('#name').value||`player_${Math.random().toString(36).slice(2,6)}`; me.room=$('#room').value||'room1'; me.color=$('#color')?$('#color').value:'#22c55e'; $('#roomLabel').textContent=me.room; state.mode='multi'; connect(); };
$('#startBtn').onclick = ()=>{ if(state.mode==='solo') startSolo(); else startMulti(); }
$('#soloBtn').onclick = ()=>{ state.mode='solo'; $('#connState').textContent = 'ソロ'; toast('ソロ練習モード'); startSolo(); };

// URL パラメータで自動 join
(function(){ const u=new URL(location.href); const room=u.searchParams.get('room'); const name=u.searchParams.get('name'); const wsx=u.searchParams.get('ws'); if(wsx){ wsUrl=wsx; $('#wsUrl').textContent=wsUrl; $('#wsInput').value=wsUrl; }
  if(room){ $('#room').value=room; } if(name){ $('#name').value=name; }
  if(room||name){ $('#joinBtn').click(); }
})();

// SVG 読み込み（ファイル）
$('#svgFile').addEventListener('change', async (ev)=>{
  const file = ev.target.files[0]; if(!file) return; const text = await file.text(); loadSVGText(text);
});

// デモ SVG（簡易）
$('#loadDemo').onclick = ()=>{
  const demo = `<?xml version="1.0" encoding="UTF-8"?><svg viewBox="0 0 600 400" xmlns="http://www.w3.org/2000/svg">
   <rect width="100%" height="100%" fill="#eef2ff"/>
   <g id="北海道"><path d="M60,60 L160,40 L200,80 L160,120 L80,120 Z" fill="#c7d2fe" stroke="#334155"/></g>
   <g id="沖縄県"><circle cx="520" cy="340" r="18" fill="#c7d2fe" stroke="#334155"/></g>
   <g id="東京都"><rect x="320" y="200" width="24" height="24" fill="#c7d2fe" stroke="#334155"/></g>
   <text x="70" y="30" font-size="14">（デモ）ざっくり配置</text>
  </svg>`;
  loadSVGText(demo);
};

function loadSVGText(text){
  const container = document.createElement('div'); container.innerHTML = text.trim();
  const svg = container.querySelector('svg');
  if(!svg){ toast('SVG が見つかりません'); return; }
  $('#mapContainer').innerHTML=''; $('#mapContainer').appendChild(svg);
  state.svgDoc = svg;
  attachHandlersToSVG(svg);
  // 質問ボタン活性
  $('#startBtn').disabled = false;
  // 初期問題セット（ソロ）
  if(state.mode==='solo'){ startSolo(); }
}

// スキップボタン
if(document.getElementById('skipBtn')){
  document.getElementById('skipBtn').onclick = ()=>{
    if(state.mode==='solo'){ state.turn++; nextQuestion(); }
    else { send({ type:'skip', room: me.room, id: me.id, name: me.name }); }
  };
}

// スコア表示
function renderScores(){
  const tb = $('#scoreTable tbody'); tb.innerHTML='';
  Object.entries(state.scores).sort((a,b)=>b[1]-a[1]).forEach(([name,sc])=>{
    const tr=document.createElement('tr'); tr.innerHTML=`<td>${name}</td><td class="score">${sc}</td>`; tb.appendChild(tr);
  });
}
</script>

<!-- ====== 同梱用：Node WebSocket サーバ（server.js） ======
保存名: server.js

const http = require('http');
const WebSocket = require('ws');
const server = http.createServer();
const wss = new WebSocket.Server({ server });

const rooms = new Map(); // roomId -> { players: Map(ws -> {id,name,score}), questions:[], turn:0 }

function broadcast(roomId, data){ const room=rooms.get(roomId); if(!room) return; const msg=JSON.stringify(data);
  for(const ws of room.players.keys()){ if(ws.readyState===1){ ws.send(msg); } }
}
function normName(s){ return (s||'').replace(/\s+/g,'').replace(/[都道府県府 ]/g,''); }
function makeQuestions(prefList, n=10){ const arr=[...prefList]; for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr.slice(0, Math.min(n, arr.length)); }

let nextId = 1;

wss.on('connection', (ws)=>{
  ws.on('message', (data)=>{
    let msg={}; try{ msg = JSON.parse(data); }catch(_){ return; }
    if(msg.type==='join'){
      const roomId = msg.room || 'room1';
      const name = (msg.name || `player_${Math.random().toString(36).slice(2,6)}`).slice(0,20);
      if(!rooms.has(roomId)) rooms.set(roomId, { players: new Map(), questions: [], turn:0 });
      const room = rooms.get(roomId);
      const id = nextId++;
      room.players.set(ws, { id, name, score:0, color: msg.color || '#22c55e' });
      ws._roomId = roomId; ws._id = id; ws._name = name;
      // 返答
      const scores = {}; for(const p of room.players.values()){ scores[p.name]=p.score; }
      ws.send(JSON.stringify({ type:'joined', id, players: room.players.size, scores }));
      broadcast(roomId, { type:'players', players: room.players.size, scores });
    }
    else if(msg.type==='start'){
      const roomId = msg.room; const room = rooms.get(roomId); if(!room) return;
      // 既存の SVG から prefecture ids を送ることはできないので、クライアント側のロード後に set を想定。
      // ここでは代表的な都道府県名セットを用意（必要に応じて編集）。
      const baseList = ['北海道','青森県','岩手県','宮城県','秋田県','山形県','福島県','茨城県','栃木県','群馬県','埼玉県','千葉県','東京都','神奈川県','新潟県','富山県','石川県','福井県','山梨県','長野県','岐阜県','静岡県','愛知県','三重県','滋賀県','京都府','大阪府','兵庫県','奈良県','和歌山県','鳥取県','島根県','岡山県','広島県','山口県','徳島県','香川県','愛媛県','高知県','福岡県','佐賀県','長崎県','熊本県','大分県','宮崎県','鹿児島県','沖縄県'];
      room.questions = makeQuestions(baseList, 10);
      room.turn = 0;
      broadcast(roomId, { type:'start', questions: room.questions });
    }
    $1    else if(msg.type==='skip'){
      const roomId = msg.room; const room = rooms.get(roomId); if(!room) return;
      room.turn += 1; const next = room.questions[room.turn];
      broadcast(roomId, { type:'advance', turn: room.turn, question: next });
    }
  });
  ws.on('close', ()=>{
    const roomId=ws._roomId; const room = rooms.get(roomId); if(!room) return;
    room.players.delete(ws);
    const scores = {}; for(const p of room.players.values()){ scores[p.name]=p.score; }
    broadcast(roomId, { type:'players', players: room.players.size, scores });
  });
});

const PORT = process.env.PORT || 3000;
server.listen(PORT, ()=>console.log(`WS server listening on ${PORT}`));
// ====== server.js ここまで ======
-->

</body>
</html>
