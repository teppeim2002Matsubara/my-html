<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>éƒ½é“åºœçœŒãƒãƒˆãƒ«ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼‰ v1.4</title>
  <style>
    html, body { height:100%; margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif; }
    header { display:flex; gap:12px; align-items:center; padding:10px 14px; box-shadow:0 1px 0 rgba(0,0,0,.08); position:sticky; top:0; background:#fff; z-index:10; }
    .brand { font-weight:700; }
    .row { display:flex; gap:16px; padding:14px; }
    .col { flex:1; min-width:300px; }
    fieldset { border:1px solid #e5e7eb; border-radius:12px; padding:12px; }
    legend { padding:0 6px; color:#374151; }
    label { font-size:12px; color:#374151; }
    input, button, select { border:1px solid #d1d5db; border-radius:10px; padding:8px 10px; font-size:14px; }
    input[type="color"]{ padding:0; height:34px; width:48px; }
    button { cursor:pointer; }
    button.primary { background:#111827; color:#fff; border-color:#111827; }
    button.ghost { background:#fff; }
    .stack { display:flex; flex-direction:column; gap:8px; }
    .side { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .board { display:flex; gap:16px; align-items:flex-start; }
    .mapwrap { position:relative; border:1px solid #e5e7eb; border-radius:12px; overflow:hidden; background:#f9fafb; }
    #mapContainer { width:100%; height:70vh; display:grid; place-items:center; }
    svg { width:100%; height:100%; }
    /* åœ°å›³ã®ã™ãä¸Šã«å•é¡Œãƒãƒ¼ï¼ˆiPadè¦‹ã‚„ã™ãï¼‰ */
    .questionBar { position:sticky; top:60px; z-index:9; background:#fff; display:flex; align-items:center; justify-content:space-between; gap:10px; padding:8px 10px; border:1px solid #e5e7eb; border-radius:10px; margin:0 0 8px 0; }
    .question { font-size:18px; font-weight:700; }
    .highlight-correct { opacity:.95; transition: fill .2s ease; } /* fillã¯æŒ‡å®šã—ãªã„ï¼ˆè‰²ã‚’ä¸Šæ›¸ãã—ãªã„ãŸã‚ï¼‰ */
    .highlight-wrong { fill:#ef4444 !important; opacity:.9; transition:fill .2s ease; }
    .hoverable { cursor:pointer; }
    .score { font-variant-numeric: tabular-nums; }
    table { border-collapse: collapse; width:100%; }
    th, td { border-bottom:1px solid #e5e7eb; padding:6px 4px; font-size:14px; text-align:left; }
    .hint { font-size:12px; color:#6b7280; }
    .toast { position:fixed; right:12px; bottom:12px; background:#111827; color:#fff; padding:10px 12px; border-radius:10px; font-size:13px; opacity:0; transform:translateY(10px); transition:all .2s ease; }
    .toast.show { opacity:1; transform:translateY(0); }
  </style>
</head>
<body>
  <header>
    <div class="brand">ğŸ—¾ éƒ½é“åºœçœŒãƒãƒˆãƒ«ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼‰</div>
    <div class="side" style="gap:10px;">
      <span>çŠ¶æ…‹: <b id="connState">ã‚ªãƒ•ãƒ©ã‚¤ãƒ³</b></span>
      <span>ãƒ«ãƒ¼ãƒ : <b id="roomLabel">-</b></span>
      <span>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼: <b id="playersCount">0</b></span>
    </div>
    <div style="margin-left:auto" class="side">
      <button class="ghost" id="soloBtn" title="ã‚µãƒ¼ãƒãªã—ã§ç·´ç¿’">ã‚½ãƒ­ç·´ç¿’</button>
      <button class="primary" id="startBtn" disabled>å¯¾æˆ¦ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
    </div>
  </header>

  <div class="row">
    <div class="col">
      <fieldset class="stack">
        <legend>å‚åŠ </legend>
        <div class="side" style="gap:10px;">
          <label>åå‰</label>
          <input id="name" placeholder="ä¾‹: ã¦ã£ãºã„" size="10" />
          <label>è‰²</label>
          <input type="color" id="color" value="#22c55e" title="è‡ªåˆ†ã®æ­£è§£ã‚«ãƒ©ãƒ¼" />
          <label>ãƒ«ãƒ¼ãƒ </label>
          <input id="room" placeholder="ä¾‹: meg1" size="8" />
          <button id="joinBtn">å…¥å®¤</button>
        </div>
        <div class="hint">WS ã‚µãƒ¼ãƒï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰: <span id="wsUrl" style="font-family:ui-monospace">wss://calisthenical-migdalia-cousinly.ngrok-free.dev</span></div>
        <div class="side">
          <label>WS URL</label>
          <input id="wsInput" value="wss://calisthenical-migdalia-cousinly.ngrok-free.dev" size="36" />
          <button id="wsApply">é©ç”¨</button>
        </div>
        <div class="hint">URL ã« <span style="font-family:ui-monospace">?room=XXXX&name=YYY&color=%23ff0000</span> ã‚’ä»˜ã‘ã¦ã‚‚OKã€‚</div>
      </fieldset>

      <fieldset class="stack" style="margin-top:12px;">
        <legend>åœ°å›³ã®èª­ã¿è¾¼ã¿</legend>
        <div class="stack">
          <input type="file" id="svgFile" accept="image/svg+xml" />
          <div class="hint">SVG ã®éƒ½é“åºœçœŒè¦ç´ ã« <span style="font-family:ui-monospace">data-name="ç¦å²¡çœŒ"</span> ãªã©ã‚’ä»˜ã‘ã‚‹ã¨ç¢ºå®Ÿã§ã™ï¼ˆãªã‘ã‚Œã° <code>aria-label</code> / <code>inkscape:label</code> / å­<code>&lt;title&gt;</code> / id ã®é †ã§åˆ¤å®šï¼‰ã€‚</div>
          <details>
            <summary>ãƒŸãƒ‹ãƒ‡ãƒ¢ï¼ˆåŒ—æµ·é“ãƒ»æ²–ç¸„ãƒ»æ±äº¬ï¼‰ã‚’èª­ã¿è¾¼ã¿</summary>
            <button id="loadDemo">ãƒ‡ãƒ¢SVGã‚’èª­ã¿è¾¼ã¿</button>
          </details>
        </div>
      </fieldset>

      <fieldset class="stack" style="margin-top:12px;">
        <legend>å•é¡Œ / ã‚¹ã‚³ã‚¢</legend>
        <div>ã‚¿ãƒ¼ãƒ³: <span id="turn">0</span> / <span id="turnMax">0</span></div>
        <table id="scoreTable" style="margin-top:8px;">
          <thead><tr><th>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</th><th>è‰²</th><th>ã‚¹ã‚³ã‚¢</th></tr></thead>
          <tbody></tbody>
        </table>
      </fieldset>
    </div>

    <div class="col board">
      <div class="questionBar">
        <div class="question">Q: <span id="question">ï¼ˆèª­ã¿è¾¼ã¿å¾…ã¡ï¼‰</span></div>
        <div class="side">
          <button id="skipBtn" title="æ¬¡ã®å•é¡Œã¸">ã‚¹ã‚­ãƒƒãƒ—â–¶</button>
        </div>
      </div>
      <div class="mapwrap" style="flex:1;">
        <div id="mapContainer"><div class="hint">å·¦ã§ SVG ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚</div></div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
/* ========= ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ========= */
const $ = (s)=>document.querySelector(s);
function toast(msg){ const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1200); }
function normName(s){ return (s||'').replace(/\s+/g,'').replace(/[éƒ½é“åºœçœŒåºœ ]/g,''); }
function getDisplayName(el){
  if(!el) return '';
  const t = el.getAttribute('data-name')
    || el.getAttribute('aria-label')
    || el.getAttribute('inkscape:label')
    || (el.querySelector && el.querySelector('title') && el.querySelector('title').textContent)
    || el.id || '';
  return t.trim();
}

/* ========= çŠ¶æ…‹ ========= */
let ws=null; let wsUrl='wss://calisthenical-migdalia-cousinly.ngrok-free.dev';
let me={ id:null, name:'', room:'', color:'#22c55e' };
let state={
  mode:'solo',
  questionList:[],
  turn:0,
  turnMax:10,
  current:null,
  scores:{},
  playerColors:{}, // name->color
  clickable:true,
  svgDoc:null,
  prefectures:[],
  svgLoaded:false
};
function updateButtons(){ const ok = state.svgLoaded && (state.mode==='solo' || (ws && ws.readyState===1)); $('#startBtn').disabled=!ok; }

/* ========= WebSocket ========= */
function connect(){
  if(ws){ try{ ws.close(); }catch(e){} }
  ws = new WebSocket(wsUrl);
  $('#connState').textContent='æ¥ç¶šä¸­â€¦';

  ws.onopen=()=>{
    $('#connState').textContent='ã‚ªãƒ³ãƒ©ã‚¤ãƒ³';
    // æ¥ç¶šæ™‚ç‚¹ã§åå‰/ãƒ«ãƒ¼ãƒ ãŒå…¥ã£ã¦ã„ã‚Œã°å³ join
    if(me.room && me.name) send({type:'join', room:me.room, name:me.name, color:me.color});
    updateButtons();
  };
  ws.onclose=()=>{ $('#connState').textContent='ã‚ªãƒ•ãƒ©ã‚¤ãƒ³'; updateButtons(); };
  ws.onerror=()=>{ $('#connState').textContent='ã‚¨ãƒ©ãƒ¼'; updateButtons(); };
  ws.onmessage=(ev)=>{
    const msg = JSON.parse(ev.data);
    switch(msg.type){
      case 'joined':
        me.id = msg.id;
        $('#playersCount').textContent = msg.players;
        state.scores = msg.scores || {};
        if(msg.colors) state.playerColors = msg.colors;
        renderScores();
        break;
      case 'players':
        $('#playersCount').textContent = msg.players;
        state.scores = msg.scores || {};
        if(msg.colors) state.playerColors = msg.colors;
        renderScores();
        break;
      case 'start':
        state.mode='multi';
        state.questionList = msg.questions;
        state.turn=0; state.turnMax=msg.questions.length;
        nextQuestion(); $('#turnMax').textContent=state.turnMax;
        break;
      case 'click-result':
        showClickResult(msg);
        break;
      case 'advance':
        state.turn = msg.turn;
        setQuestion(msg.question);
        $('#turn').textContent = (state.turn+1);
        break;
      case 'scores':
        state.scores = msg.scores || {};
        if(msg.colors) state.playerColors = msg.colors;
        renderScores();
        break;
    }
  };
}
function send(o){ if(ws && ws.readyState===1) ws.send(JSON.stringify(o)); }

/* ========= ã‚²ãƒ¼ãƒ  ========= */
function setQuestion(name){ state.current=name; $('#question').textContent = name || 'ï¼ˆå•é¡Œãªã—ï¼‰'; }
function nextQuestion(){
  if(state.turn >= state.turnMax){ setQuestion('çµ‚äº†ï¼'); state.clickable=false; return; }
  const q = state.questionList[state.turn]; setQuestion(q); $('#turn').textContent=(state.turn+1);
}
function startSolo(){
  state.mode='solo';
  if(!state.prefectures.length){ toast('å…ˆã«SVGã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„'); return; }
  const prefNames=[ 'åŒ—æµ·é“','é’æ£®çœŒ','å²©æ‰‹çœŒ','å®®åŸçœŒ','ç§‹ç”°çœŒ','å±±å½¢çœŒ','ç¦å³¶çœŒ','èŒ¨åŸçœŒ','æ ƒæœ¨çœŒ','ç¾¤é¦¬çœŒ','åŸ¼ç‰çœŒ','åƒè‘‰çœŒ','æ±äº¬éƒ½','ç¥å¥ˆå·çœŒ','æ–°æ½ŸçœŒ','å¯Œå±±çœŒ','çŸ³å·çœŒ','ç¦äº•çœŒ','å±±æ¢¨çœŒ','é•·é‡çœŒ','å²é˜œçœŒ','é™å²¡çœŒ','æ„›çŸ¥çœŒ','ä¸‰é‡çœŒ','æ»‹è³€çœŒ','äº¬éƒ½åºœ','å¤§é˜ªåºœ','å…µåº«çœŒ','å¥ˆè‰¯çœŒ','å’Œæ­Œå±±çœŒ','é³¥å–çœŒ','å³¶æ ¹çœŒ','å²¡å±±çœŒ','åºƒå³¶çœŒ','å±±å£çœŒ','å¾³å³¶çœŒ','é¦™å·çœŒ','æ„›åª›çœŒ','é«˜çŸ¥çœŒ','ç¦å²¡çœŒ','ä½è³€çœŒ','é•·å´çœŒ','ç†Šæœ¬çœŒ','å¤§åˆ†çœŒ','å®®å´çœŒ','é¹¿å…å³¶çœŒ','æ²–ç¸„çœŒ' ];
  const allow = new Set(prefNames.map(n=>normName(n)));
  const names = state.prefectures.map(el=>getDisplayName(el)).filter(n=>allow.has(normName(n)));
  state.questionList = shuffle(names).slice(0, Math.min(10, names.length));
  state.turn=0; state.turnMax=state.questionList.length; $('#turnMax').textContent=state.turnMax;
  state.scores={}; renderScores(); highlightClear(); state.clickable=true; nextQuestion(); updateButtons();
}
function startMulti(){ send({type:'start', room: me.room}); }

function onMapClick(target){
  if(!state.clickable || !state.current) return;
  const clickedId = (target.id||'').trim();
  const clickedName = getDisplayName(target);
  if(!clickedId && !clickedName){ toast('ã“ã®è¦ç´ ã« id/åå‰ ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
  const good = normName(clickedName) === normName(state.current);

  if(state.mode==='solo'){
    if(good){ highlight(target, me.color||'#22c55e'); toast('æ­£è§£ï¼'); state.turn++; nextQuestion(); }
    else { flashWrong(target); toast('ã¡ãŒã†ã‚ˆ'); }
  }else{
    // å¾Œæ–¹äº’æ›ã®ãŸã‚å…¨éƒ¨é€ã‚‹
    send({ type:'click', room: me.room, id: me.id, name: me.name, color: me.color,
           answer: clickedName, answerName: clickedName, answerId: clickedId });
  }
}

function showClickResult(msg){
  if(!state.svgDoc) return;
  let el = null;
  if(msg.clickedId) el = state.svgDoc.getElementById(msg.clickedId);
  if(!el && msg.answer){ // æ—§ã‚µãƒ¼ãƒäº’æ›: åå‰ã‹ã‚‰è¦ç´ æ¨å®š
    const targetName = msg.answer;
    el = state.prefectures.find(node => normName(getDisplayName(node)) === normName(targetName));
  }
  if(!el) return;

  if(msg.correct){
    const col = msg.color || state.playerColors[msg.name] || '#22c55e';
    highlight(el, col);
  } else {
    flashWrong(el);
  }
  if(msg.next){ state.turn = msg.turn; setQuestion(msg.next); $('#turn').textContent=(state.turn+1); }
}

/* ========= SVG ========= */
function attachHandlersToSVG(root){
  const sels=['path','polygon','rect','circle','ellipse','g'];
  const els=[];
  sels.forEach(s=> root.querySelectorAll(s).forEach(el=>{
    // ã‚¯ãƒªãƒƒã‚¯å¯¾è±¡ã¯ id ã‚’æŒã¤è¦ç´  or ã‚°ãƒ«ãƒ¼ãƒ—
    if(el.id){ els.push(el); el.classList.add('hoverable'); el.addEventListener('click',(e)=>{ e.stopPropagation(); onMapClick(el); }, false); }
  }));
  state.prefectures = els; state.svgLoaded=true; updateButtons();
}
function paintElement(el, color){
  if(!el) return;
  const tag = (el.tagName||'').toLowerCase();
  const targets = (tag==='g') ? el.querySelectorAll('path,polygon,rect,circle,ellipse') : [el];
  targets.forEach(node=>{ if(color){ node.style.fill=color; node.setAttribute('fill', color); } });
}
function highlight(el,color){ el.classList.remove('highlight-wrong'); paintElement(el,color); el.classList.add('highlight-correct'); }
function highlightClear(){ state.prefectures.forEach(el=>{ el.classList.remove('highlight-correct','highlight-wrong'); el.style.fill=''; el.removeAttribute('fill'); }); }
function flashWrong(el){ el.classList.add('highlight-wrong'); setTimeout(()=>el.classList.remove('highlight-wrong'),600); }
function shuffle(a){ const arr=[...a]; for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }

/* ========= UI ========= */
$('#wsApply').onclick=()=>{
  const v=$('#wsInput').value.trim(); if(!v){ toast('WS URL ã‚’å…¥åŠ›'); return; }
  try{ const u=new URL(v); if(u.protocol!=='ws:' && u.protocol!=='wss:'){ toast('ws:// ã¾ãŸã¯ wss://'); return; } }catch(_){ toast('WS URL ãŒä¸æ­£'); return; }
  wsUrl=v; $('#wsUrl').textContent=v; connect();
};
$('#joinBtn').onclick=()=>{
  me.name=$('#name').value||`player_${Math.random().toString(36).slice(2,6)}`;
  me.room=$('#room').value||'room1';
  me.color=$('#color')?$('#color').value:'#22c55e';
  state.playerColors[me.name]=me.color; // è‡ªåˆ†è‰²ã‚’ç™»éŒ²
  $('#roomLabel').textContent=me.room;
  state.mode='multi';
  if(ws && ws.readyState===1){ // æ¥ç¶šæ¸ˆã¿ãªã‚‰å³ join
    send({type:'join', room:me.room, name:me.name, color:me.color});
  } else {
    connect(); // æœªæ¥ç¶šâ†’onopenã§join
  }
};
$('#startBtn').onclick=()=>{ if(state.mode==='solo') startSolo(); else startMulti(); };
$('#soloBtn').onclick=()=>{ state.mode='solo'; $('#connState').textContent='ã‚½ãƒ­'; toast('ã‚½ãƒ­ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰'); updateButtons(); if(state.svgLoaded) startSolo(); };
$('#skipBtn').onclick=()=>{ if(state.mode==='solo'){ state.turn++; nextQuestion(); } else { send({ type:'skip', room: me.room, id: me.id, name: me.name }); } };

// URL ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
(function(){
  const u=new URL(location.href);
  const room=u.searchParams.get('room'); const name=u.searchParams.get('name');
  const wsx=u.searchParams.get('ws'); const col=u.searchParams.get('color');
  if(wsx){ $('#wsInput').value=wsx; $('#wsApply').click(); } else { connect(); }
  if(room) $('#room').value=room; if(name) $('#name').value=name; if(col) $('#color').value=col;
})();

// SVG èª­ã¿è¾¼ã¿
$('#svgFile').addEventListener('change', async(ev)=>{ const f=ev.target.files[0]; if(!f) return; const text=await f.text(); if(/^%PDF-/.test(text.slice(0,8))){ toast('PDFã¯ç›´æ¥èª­ã‚ã¾ã›ã‚“ã€‚SVGã¸å¤‰æ›ã‚’ã€‚'); return; } loadSVGText(text); });
function loadSVGText(text){
  try{
    const parser=new DOMParser(); const doc=parser.parseFromString(text,'image/svg+xml');
    const svg=doc.querySelector('svg'); if(!svg){ toast('SVGã‚¿ã‚°ãªã—'); return; }
    $('#mapContainer').innerHTML=''; const imported=document.importNode(svg,true); $('#mapContainer').appendChild(imported);
    state.svgDoc=imported; attachHandlersToSVG(imported);
    $('#question').textContent='ï¼ˆæº–å‚™OKï¼šé–‹å§‹ã—ã¦ä¸‹ã•ã„ï¼‰'; updateButtons();
  }catch(e){ toast('SVGè§£æã«å¤±æ•—'); }
}

// ãƒ‡ãƒ¢SVG
$('#loadDemo').onclick=()=>{
  const demo=`<?xml version="1.0" encoding="UTF-8"?><svg viewBox="0 0 600 400" xmlns="http://www.w3.org/2000/svg">
   <rect width="100%" height="100%" fill="#eef2ff"/>
   <g id="åŒ—æµ·é“" data-name="åŒ—æµ·é“"><path d="M60,60 L160,40 L200,80 L160,120 L80,120 Z" fill="#c7d2fe" stroke="#334155"/></g>
   <g id="æ²–ç¸„çœŒ" data-name="æ²–ç¸„çœŒ"><circle cx="520" cy="340" r="18" fill="#c7d2fe" stroke="#334155"/></g>
   <g id="æ±äº¬éƒ½" data-name="æ±äº¬éƒ½"><rect x="320" y="200" width="24" height="24" fill="#c7d2fe" stroke="#334155"/></g>
   <text x="70" y="30" font-size="14">ï¼ˆãƒ‡ãƒ¢ï¼‰ã–ã£ãã‚Šé…ç½®</text>
  </svg>`;
  loadSVGText(demo);
};

function renderScores(){
  const tb=$('#scoreTable tbody'); tb.innerHTML='';
  Object.entries(state.scores).sort((a,b)=>b[1]-a[1]).forEach(([name,sc])=>{
    const color = state.playerColors[name] || '#22c55e';
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${name}</td><td><span style="display:inline-block;width:14px;height:14px;border-radius:50%;background:${color};border:1px solid #d1d5db"></span></td><td class="score">${sc}</td>`;
    tb.appendChild(tr);
  });
}
</script>

<!-- ====== åŒæ¢±ç”¨ï¼šNode WebSocket ã‚µãƒ¼ãƒï¼ˆserver.jsï¼‰ ======
ä¿å­˜å: server.js

const http = require('http');
const WebSocket = require('ws');
const server = http.createServer();
const wss = new WebSocket.Server({ server });

// roomId -> { players: Map(ws -> {id,name,score,color}), questions:[], turn:0, colors: {name: color} }
const rooms = new Map();

function broadcast(roomId, data){
  const room=rooms.get(roomId); if(!room) return;
  const msg=JSON.stringify(data);
  for(const ws of room.players.keys()){ if(ws.readyState===1){ ws.send(msg); } }
}
function normName(s){ return (s||'').replace(/\\s+/g,'').replace(/[éƒ½é“åºœçœŒåºœ ]/g,''); }
function makeQuestions(prefList, n=10){ const arr=[...prefList];
  for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; }
  return arr.slice(0, Math.min(n, arr.length));
}

let nextId = 1;

wss.on('connection', (ws)=>{
  ws.on('message', (data)=>{
    let msg={}; try{ msg = JSON.parse(data); }catch(_){ return; }

    if(msg.type==='join'){
      const roomId = msg.room || 'room1';
      const name = (msg.name || `player_${Math.random().toString(36).slice(2,6)}`).slice(0,20);
      const color = msg.color || '#22c55e';
      if(!rooms.has(roomId)) rooms.set(roomId, { players: new Map(), questions: [], turn:0, colors:{} });
      const room = rooms.get(roomId);
      const id = nextId++;
      room.players.set(ws, { id, name, score:0, color });
      room.colors[name] = color;
      ws._roomId = roomId; ws._id = id; ws._name = name;

      const scores = {}; for(const p of room.players.values()){ scores[p.name]=p.score; }
      ws.send(JSON.stringify({ type:'joined', id, players: room.players.size, scores, colors: room.colors }));
      broadcast(roomId, { type:'players', players: room.players.size, scores, colors: room.colors });
    }

    else if(msg.type==='start'){
      const roomId = msg.room; const room = rooms.get(roomId); if(!room) return;
      const baseList = ['åŒ—æµ·é“','é’æ£®çœŒ','å²©æ‰‹çœŒ','å®®åŸçœŒ','ç§‹ç”°çœŒ','å±±å½¢çœŒ','ç¦å³¶çœŒ','èŒ¨åŸçœŒ','æ ƒæœ¨çœŒ','ç¾¤é¦¬çœŒ','åŸ¼ç‰çœŒ','åƒè‘‰çœŒ','æ±äº¬éƒ½','ç¥å¥ˆå·çœŒ','æ–°æ½ŸçœŒ','å¯Œå±±çœŒ','çŸ³å·çœŒ','ç¦äº•çœŒ','å±±æ¢¨çœŒ','é•·é‡çœŒ','å²é˜œçœŒ','é™å²¡çœŒ','æ„›çŸ¥çœŒ','ä¸‰é‡çœŒ','æ»‹è³€çœŒ','äº¬éƒ½åºœ','å¤§é˜ªåºœ','å…µåº«çœŒ','å¥ˆè‰¯çœŒ','å’Œæ­Œå±±çœŒ','é³¥å–çœŒ','å³¶æ ¹çœŒ','å²¡å±±çœŒ','åºƒå³¶çœŒ','å±±å£çœŒ','å¾³å³¶çœŒ','é¦™å·çœŒ','æ„›åª›çœŒ','é«˜çŸ¥çœŒ','ç¦å²¡çœŒ','ä½è³€çœŒ','é•·å´çœŒ','ç†Šæœ¬çœŒ','å¤§åˆ†çœŒ','å®®å´çœŒ','é¹¿å…å³¶çœŒ','æ²–ç¸„çœŒ'];
      room.questions = makeQuestions(baseList, 10);
      room.turn = 0;
      broadcast(roomId, { type:'start', questions: room.questions });
    }

    else if(msg.type==='click'){
      const roomId = msg.room; const room = rooms.get(roomId); if(!room) return;
      const p = room.players.get(ws); if(!p) return;
      const current = room.questions[room.turn]; if(!current) return;

      // äº’æ›ï¼šanswerName å„ªå…ˆã€ãªã‘ã‚Œã° answer
      const providedName = msg.answerName || msg.answer || '';
      const good = normName(providedName) === normName(current);

      if(good){
        p.score += 1;
        room.turn += 1;
        const next = room.questions[room.turn];
        broadcast(roomId, { type:'click-result', name:p.name, color:p.color, clickedId: msg.answerId, correct: true, turn: room.turn, next });
        const scores = {}; for(const q of room.players.values()){ scores[q.name]=q.score; }
        broadcast(roomId, { type:'scores', scores, colors: room.colors });
      } else {
        ws.send(JSON.stringify({ type:'click-result', name:p.name, color:p.color, clickedId: msg.answerId, correct: false, turn: room.turn }));
      }
    }

    else if(msg.type==='skip'){
      const roomId = msg.room; const room = rooms.get(roomId); if(!room) return;
      room.turn += 1; const next = room.questions[room.turn];
      broadcast(roomId, { type:'advance', turn: room.turn, question: next });
    }
  });

  ws.on('close', ()=>{
    const roomId=ws._roomId; const room = rooms.get(roomId); if(!room) return;
    room.players.delete(ws);
    const scores = {}; for(const p of room.players.values()){ scores[p.name]=p.score; }
    broadcast(roomId, { type:'players', players: room.players.size, scores, colors: room.colors });
  });
});

const PORT = process.env.PORT || 3000;
server.listen(PORT, ()=>console.log(`WS server listening on ${PORT}`));
// ====== server.js ã“ã“ã¾ã§ ======
-->
</body>
</html>
