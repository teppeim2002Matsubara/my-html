<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>éƒ½é“åºœçœŒãƒãƒˆãƒ«ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼‰ â€“ å›ºå®šç‰ˆ v1.1</title>
  <!--
  å¤‰æ›´ç‚¹ (v1.1):
  - WebSocket åˆæœŸåŒ–å¾…ã¡ã®ã‚­ãƒ¥ãƒ¼(sendSafe)ã‚’å®Ÿè£… â†’ ã€Œshared Env not inited yetã€å¯¾ç­–
  - æ¥ç¶šçŠ¶æ…‹ã¨SVGèª­è¾¼å®Œäº†ã‚’æº€ãŸã•ãªã„é™ã‚Šã€Œå¯¾æˆ¦ã‚¹ã‚¿ãƒ¼ãƒˆã€ã‚’ç„¡åŠ¹åŒ–
  - SVG ãƒ­ãƒ¼ãƒ€ã®å …ç‰¢åŒ–: PDFã‚„ä¸æ­£XMLã‚’æ¤œå‡ºã—ã€è©³ç´°ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
  - ã‚¯ãƒªãƒƒã‚¯åˆ¤å®šã®å …ç‰¢åŒ–: null å‚ç…§é˜²æ­¢ã€SVGç„¡èª­è¾¼æ™‚ã®ã‚¬ãƒ¼ãƒ‰
  - è¨ºæ–­ãƒ‘ãƒãƒ«(ç”»é¢å³ä¸‹)ã‚’è¿½åŠ : æ¥ç¶š/ãƒ•ã‚¡ã‚¤ãƒ«/ID/ãƒ­ã‚°ã‚’å¯è¦–åŒ–
  - æœ€å°â€œãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹â€ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ï¼ˆãƒ‡ãƒ¢èª­è¾¼/èª¤ãƒ•ã‚¡ã‚¤ãƒ«/WS URL å¦¥å½“æ€§/æ¥ç¶šå‰joinï¼‰
  - HTTPSç’°å¢ƒã® wss æ¨å¥¨ãƒã‚§ãƒƒã‚¯
  -->
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif; }
    header { display:flex; gap:12px; align-items:center; padding:10px 14px; box-shadow: 0 1px 0 rgba(0,0,0,.08); position: sticky; top:0; background:#fff; z-index:2; }
    .brand { font-weight:700; }
    .row { display:flex; gap:16px; padding:14px; }
    .col { flex:1; min-width: 300px; }
    fieldset { border:1px solid #e5e7eb; border-radius:12px; padding:12px; }
    legend { padding: 0 6px; color:#374151; }
    label { font-size: 12px; color:#374151; }
    input, button, select { border:1px solid #d1d5db; border-radius:10px; padding:8px 10px; font-size:14px; }
    button { cursor:pointer; }
    button.primary { background:#111827; color:#fff; border-color:#111827; }
    button.ghost { background:#fff; }
    .stack { display:flex; flex-direction: column; gap:8px; }
    .side { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .status { font-size:13px; color:#4b5563; }
    .board { display:flex; gap:16px; align-items:flex-start; }
    .mapwrap { position:relative; border:1px solid #e5e7eb; border-radius:12px; overflow:hidden; background:#f9fafb; }
    #mapContainer { width: 100%; height: 70vh; display:grid; place-items:center; }
    svg { width: 100%; height: 100%; }
    .question { font-size: 18px; font-weight: 700; }
    .highlight-correct { fill: #22c55e !important; opacity: .9; transition: fill .2s ease; }
    .highlight-wrong { fill: #ef4444 !important; opacity:.9; transition: fill .2s ease; }
    .hoverable { cursor:pointer; }
    .score { font-variant-numeric: tabular-nums; }
    table { border-collapse: collapse; width:100%; }
    th, td { border-bottom:1px solid #e5e7eb; padding:6px 4px; font-size:14px; text-align:left; }
    .hint { font-size: 12px; color:#6b7280; }
    .toast { position: fixed; right: 12px; bottom: 12px; background: #111827; color: #fff; padding: 10px 12px; border-radius: 10px; font-size: 13px; opacity: 0; transform: translateY(10px); transition: all .2s ease; }
    .toast.show { opacity: 1; transform: translateY(0); }
    .chip { display:inline-flex; gap:6px; font-size:12px; color:#374151; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .foot { font-size:12px; color:#6b7280; padding: 8px 14px 16px; }
    /* è¨ºæ–­ãƒ‘ãƒãƒ« */
    .diag { position: fixed; right: 12px; bottom: 12px; width: 360px; max-height: 40vh; overflow:auto; background:#ffffff; border:1px solid #e5e7eb; border-radius:12px; box-shadow: 0 8px 24px rgba(0,0,0,.08); padding:10px; font-size:12px; }
    .diag h4 { margin: 4px 0 6px; font-size:12px; }
    .diag pre { background:#f9fafb; padding:6px; border-radius:8px; white-space:pre-wrap; word-break:break-all; }
  </style>
</head>
<body>
  <header>
    <div class="brand">ğŸ—¾ éƒ½é“åºœçœŒãƒãƒˆãƒ«ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼‰</div>
    <div class="chip">çŠ¶æ…‹: <span id="connState">ã‚ªãƒ•ãƒ©ã‚¤ãƒ³</span></div>
    <div class="chip">ãƒ«ãƒ¼ãƒ : <span id="roomLabel">-</span></div>
    <div class="chip">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼: <span id="playersCount">0</span></div>
    <div style="margin-left:auto" class="side">
      <button class="ghost" id="soloBtn" title="ã‚µãƒ¼ãƒãªã—ã§ç·´ç¿’">ã‚½ãƒ­ç·´ç¿’</button>
      <button class="primary" id="startBtn" disabled>å¯¾æˆ¦ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
    </div>
  </header>

  <div class="row">
    <div class="col">
      <fieldset class="stack">
        <legend>å‚åŠ </legend>
        <div class="side">
          <label>åå‰</label>
          <input id="name" placeholder="ä¾‹: ã¦ã£ãºã„" size="10" />
          <label>ãƒ«ãƒ¼ãƒ </label>
          <input id="room" placeholder="ä¾‹: meg1" size="8" />
          <button id="joinBtn">å…¥å®¤</button>
        </div>
        <div class="hint">WS ã‚µãƒ¼ãƒï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰: <span class="mono" id="wsUrl">ws://localhost:3000</span></div>
        <div class="side">
          <label>WS URL</label>
          <input id="wsInput" placeholder="ws://localhost:3000" size="24" />
          <button id="wsApply">é©ç”¨</button>
        </div>
        <div class="hint">URL ã« <span class="mono">?room=XXXX&name=YYY</span> ã‚’ä»˜ã‘ã¦ã‚‚OKã€‚<span id="secureHint"></span></div>
      </fieldset>

      <fieldset class="stack" style="margin-top:12px;">
        <legend>åœ°å›³ã®èª­ã¿è¾¼ã¿</legend>
        <div class="stack">
          <input type="file" id="svgFile" accept="image/svg+xml" />
          <div class="hint">â˜… PDF ã¯ç›´æ¥ã¯èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã€‚Inkscapeç­‰ã§ <b>SVGã«å¤‰æ›</b>ã—ã¦ã‹ã‚‰èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚<br>SVGå†…ã®è¦ç´ ã« <span class="mono">id="åŒ—æµ·é“"</span> ã®ã‚ˆã†ã«<b>éƒ½é“åºœçœŒåã® id</b> ã‚’ä»˜ã‘ã‚‹ã¨è‡ªå‹•åˆ¤å®šã—ã¾ã™ã€‚</div>
          <details>
            <summary>ãƒŸãƒ‹ãƒ‡ãƒ¢ï¼ˆåŒ—æµ·é“ãƒ»æ²–ç¸„ãƒ»æ±äº¬ ã ã‘ã®ç°¡æ˜“ SVG ã‚’ä½¿ã†ï¼‰</summary>
            <button id="loadDemo">ãƒ‡ãƒ¢SVGã‚’èª­ã¿è¾¼ã¿</button>
          </details>
        </div>
      </fieldset>

      <fieldset class="stack" style="margin-top:12px;">
        <legend>å•é¡Œ / ã‚¹ã‚³ã‚¢</legend>
        <div class="question">Q: <span id="question">ï¼ˆèª­ã¿è¾¼ã¿å¾…ã¡ï¼‰</span></div>
        <div class="status">ã‚¿ãƒ¼ãƒ³: <span id="turn">0</span> / <span id="turnMax">0</span></div>
        <div style="margin-top:8px;">
          <table id="scoreTable">
            <thead><tr><th>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</th><th>ã‚¹ã‚³ã‚¢</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </fieldset>

      <fieldset class="stack" style="margin-top:12px;">
        <legend>è‡ªå·±è¨ºæ–­ & ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹</legend>
        <div class="side" style="flex-wrap:wrap; gap:6px;">
          <button id="tDemo">[TC1] ãƒ‡ãƒ¢SVGèª­è¾¼</button>
          <button id="tPdf">[TC2] PDFèª¤æŠ•å…¥æ¤œå‡º</button>
          <button id="tWsUrl">[TC3] WS URL å¦¥å½“æ€§</button>
          <button id="tJoinEarly">[TC4] æ¥ç¶šå‰ join() ã‚­ãƒ¥ãƒ¼</button>
        </div>
        <div class="hint">çµæœã¯å³ä¸‹ã®ã€Œè¨ºæ–­ãƒ‘ãƒãƒ«ã€ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
      </fieldset>

      <div class="foot">
        å‡ºå…¸ï¼ˆåœ°å›³ãƒ™ãƒ¼ã‚¹ï¼‰: ã¡ã³ã‚€ã™ãƒ‰ãƒªãƒ«å¡—ã‚Šçµµæ—¥æœ¬åœ°å›³ï¼ˆPDFï¼‰â†’SVGåŒ–ã—ã¦ã”åˆ©ç”¨ãã ã•ã„ã€‚è‘—ä½œæ¨©ãƒ»åˆ©ç”¨è¦ç´„ã«ã”æ³¨æ„ãã ã•ã„ã€‚
      </div>
    </div>

    <div class="col board">
      <div class="mapwrap" style="flex:1;">
        <div id="mapContainer"><div class="hint">å·¦ã®ã€Œåœ°å›³ã®èª­ã¿è¾¼ã¿ã€ã§ SVG ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚</div></div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>
  <div class="diag" id="diag" hidden>
    <h4>è¨ºæ–­ãƒ‘ãƒãƒ«</h4>
    <div>æ¥ç¶š: <span id="dConn">-</span> / SVG: <span id="dSvg">-</span> / çœŒIDæ•°: <span id="dIds">0</span></div>
    <pre id="dLog">(ãƒ­ã‚°ã¯ã“ã“ã«å‡ºã¾ã™)</pre>
  </div>

<script>
// ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => Array.from(document.querySelectorAll(sel));
function toast(msg){ const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1400); log(msg); }
function normName(s){ return (s||'').replace(/\s+/g,'').replace(/[éƒ½é“åºœçœŒåºœ ]/g,''); }
function log(...a){ const s=a.map(x=>typeof x==='string'?x:JSON.stringify(x)).join(' '); const pre=$('#dLog'); pre.textContent += "\n"+s; pre.scrollTop=pre.scrollHeight; }
function showDiag(){ $('#diag').hidden=false; }

// ===== çŠ¶æ…‹ =====
let ws=null; let wsUrl = 'ws://localhost:3000';
let wsOpen = false; let wsReady = Promise.resolve();
let wsQueue = [];
let me = { id:null, name:'', room:'' };
let state = {
  mode: 'solo', // 'solo' or 'multi'
  questionList: [],
  turn: 0,
  turnMax: 10,
  current: null,
  scores: {},
  clickable: true,
  svgDoc: null,
  prefectures: [],
  svgLoaded: false
};

function updateButtons(){
  const canStart = state.svgLoaded && (state.mode==='solo' || wsOpen);
  $('#startBtn').disabled = !canStart;
  $('#dConn').textContent = wsOpen? 'OPEN':'CLOSED';
  $('#dSvg').textContent = state.svgLoaded? 'LOADED':'NONE';
  $('#dIds').textContent = state.prefectures.length;
}

// ===== WebSocket æ¥ç¶š (ã‚­ãƒ¥ãƒ¼+å®‰å…¨é€ä¿¡) =====
function connect(){
  if(ws){ try{ ws.close(); }catch(_){} }
  wsOpen = false;
  ws = new WebSocket(wsUrl);
  wsReady = new Promise((resolve)=>{
    ws.onopen = ()=>{ wsOpen=true; $('#connState').textContent='ã‚ªãƒ³ãƒ©ã‚¤ãƒ³'; resolve(); flushQueue(); updateButtons(); log('WS open:', wsUrl); };
  });
  ws.onclose = ()=>{ wsOpen=false; $('#connState').textContent='ã‚ªãƒ•ãƒ©ã‚¤ãƒ³'; updateButtons(); log('WS closed'); };
  ws.onerror = (e)=>{ $('#connState').textContent='ã‚¨ãƒ©ãƒ¼'; updateButtons(); log('WS error'); };
  ws.onmessage = (ev)=>{
    const msg = JSON.parse(ev.data);
    switch(msg.type){
      case 'joined': me.id = msg.id; $('#playersCount').textContent = msg.players; state.scores = msg.scores || {}; renderScores(); break;
      case 'players': $('#playersCount').textContent = msg.players; state.scores = msg.scores || {}; renderScores(); break;
      case 'start': state.mode='multi'; state.questionList = msg.questions; state.turn=0; state.turnMax = msg.questions.length; nextQuestion(); $('#turnMax').textContent = state.turnMax; break;
      case 'click-result': showClickResult(msg); break;
      case 'advance': state.turn = msg.turn; setQuestion(msg.question); break;
      case 'scores': state.scores = msg.scores||{}; renderScores(); break;
    }
  };
}
function sendSafe(o){
  if(wsOpen && ws && ws.readyState===1){ ws.send(JSON.stringify(o)); }
  else { wsQueue.push(o); log('queued', o.type); }
}
function flushQueue(){
  while(wsOpen && wsQueue.length){ const o = wsQueue.shift(); try{ ws.send(JSON.stringify(o)); }catch(e){ log('flush err', e.message); break; } }
}

// ===== ã‚²ãƒ¼ãƒ  =====
function setQuestion(name){ state.current = name; $('#question').textContent = name || 'ï¼ˆå•é¡Œãªã—ï¼‰'; }
function nextQuestion(){
  if(state.turn >= state.turnMax){ $('#question').textContent = 'çµ‚äº†ï¼'; state.clickable=false; return; }
  const q = state.questionList[state.turn]; setQuestion(q); $('#turn').textContent = (state.turn+1);
}
function startSolo(){
  state.mode='solo'; if(!state.prefectures.length){ toast('å…ˆã«SVGã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„'); return; }
  const prefNames = [
    'åŒ—æµ·é“',
    'é’æ£®çœŒ', 'å²©æ‰‹çœŒ', 'å®®åŸçœŒ', 'ç§‹ç”°çœŒ', 'å±±å½¢çœŒ', 'ç¦å³¶çœŒ',
    'èŒ¨åŸçœŒ', 'æ ƒæœ¨çœŒ', 'ç¾¤é¦¬çœŒ', 'åŸ¼ç‰çœŒ', 'åƒè‘‰çœŒ', 'æ±äº¬éƒ½', 'ç¥å¥ˆå·çœŒ',
    'æ–°æ½ŸçœŒ', 'å¯Œå±±çœŒ', 'çŸ³å·çœŒ', 'ç¦äº•çœŒ', 'å±±æ¢¨çœŒ', 'é•·é‡çœŒ',
    'å²é˜œçœŒ', 'é™å²¡çœŒ', 'æ„›çŸ¥çœŒ', 'ä¸‰é‡çœŒ',
    'æ»‹è³€çœŒ', 'äº¬éƒ½åºœ', 'å¤§é˜ªåºœ', 'å…µåº«çœŒ', 'å¥ˆè‰¯çœŒ', 'å’Œæ­Œå±±çœŒ',
    'é³¥å–çœŒ', 'å³¶æ ¹çœŒ', 'å²¡å±±çœŒ', 'åºƒå³¶çœŒ', 'å±±å£çœŒ',
    'å¾³å³¶çœŒ', 'é¦™å·çœŒ', 'æ„›åª›çœŒ', 'é«˜çŸ¥çœŒ',
    'ç¦å²¡çœŒ', 'ä½è³€çœŒ', 'é•·å´çœŒ', 'ç†Šæœ¬çœŒ', 'å¤§åˆ†çœŒ', 'å®®å´çœŒ', 'é¹¿å…å³¶çœŒ', 'æ²–ç¸„çœŒ'
  ];
  const names = state.prefectures
    .map(el=>el.id)
    .filter(id => prefNames.includes(id));
  state.questionList = shuffle(names).slice(0, Math.min(10, names.length));
  state.turn=0; state.turnMax=state.questionList.length; $('#turnMax').textContent = state.turnMax; state.scores = {}; renderScores();
  highlightClear();
  state.clickable=true;
  nextQuestion(); updateButtons();
}
function startMulti(){ sendSafe({type:'start', room: me.room}); }

function onMapClick(target){ if(!state.clickable || !state.current) return; if(!target) return; const clicked = (target.id||'').trim();
  if(!clicked){ toast('ã“ã®è¦ç´ ã« id ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
  const good = normName(clicked) === normName(state.current);
  if(state.mode==='solo'){
    if(good){ highlight(target, true); toast('æ­£è§£ï¼'); state.turn++; nextQuestion(); }
    else { flashWrong(target); toast('ã¡ãŒã†ã‚ˆ'); }
  } else {
    sendSafe({ type:'click', room: me.room, id: me.id, name: me.name, answer: clicked });
  }
}

function showClickResult(msg){
  if(!state.svgDoc) return; // SVGæœªèª­è¾¼ã‚¬ãƒ¼ãƒ‰
  const el = state.svgDoc.getElementById(msg.clickedId);
  if(!el) { log('clickedId not found in SVG:', msg.clickedId); return; }
  if(msg.correct){ highlight(el, true); }
  else { flashWrong(el); }
  if(msg.next){ state.turn = msg.turn; setQuestion(msg.next); $('#turn').textContent = (state.turn+1); }
}

// ===== SVG å–æ‰±ã„ =====
function attachHandlersToSVG(root){
  const sels=['path','polygon','rect','g'];
  const els = [];
  sels.forEach(s=> root.querySelectorAll(s).forEach(el=>{ if(el.id){ els.push(el); el.classList.add('hoverable'); el.addEventListener('click', (e)=>{ e.stopPropagation(); onMapClick(el); }, false); } }));
  state.prefectures = els; state.svgLoaded = true; updateButtons();
}

function highlight(el){ el.classList.remove('highlight-wrong'); el.classList.add('highlight-correct'); }
function highlightClear(){ state.prefectures.forEach(el=>{ el.classList.remove('highlight-correct','highlight-wrong'); }); }
function flashWrong(el){ el.classList.add('highlight-wrong'); setTimeout(()=>el.classList.remove('highlight-wrong'), 600); }
function shuffle(a){ const arr=[...a]; for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }

// ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ â†’ ãƒ†ã‚­ã‚¹ãƒˆ â†’ æ¤œè¨¼ â†’ æç”»
$('#svgFile').addEventListener('change', async (ev)=>{
  const file = ev.target.files[0]; if(!file) return; showDiag();
  if(file.type && file.type !== 'image/svg+xml'){ toast('ã“ã‚Œã¯SVGã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚PDFã¯SVGã«å¤‰æ›ã—ã¦ãã ã•ã„ã€‚'); log('file.type:', file.type); return; }
  const text = await file.text();
  if(/^%PDF-/.test(text.slice(0,8))){ toast('PDFã¯ç›´æ¥èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã€‚SVGã¸å¤‰æ›ã—ã¦ãã ã•ã„ã€‚'); log('detected PDF header'); return; }
  loadSVGText(text);
});

// ãƒ†ã‚­ã‚¹ãƒˆ â†’ SVG è§£æ
function loadSVGText(text){
  try{
    const parser = new DOMParser();
    const doc = parser.parseFromString(text, 'image/svg+xml');
    const svg = doc.querySelector('svg');
    if(!svg){ toast('SVGã‚¿ã‚°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); log('no <svg> element'); return; }
    // æ—¢å­˜ã‚’ç½®æ›
    $('#mapContainer').innerHTML='';
    const imported = document.importNode(svg, true);
    $('#mapContainer').appendChild(imported);
    state.svgDoc = imported;
    attachHandlersToSVG(imported);
    $('#question').textContent = 'ï¼ˆæº–å‚™OKï¼šå•é¡Œã‚’é–‹å§‹ã—ã¦ãã ã•ã„ï¼‰';
    updateButtons();
    log('SVG loaded, id count:', state.prefectures.length);
  }catch(e){ toast('SVG è§£æã«å¤±æ•—ã—ã¾ã—ãŸ'); log('loadSVGText error:', e.message); }
}

// ãƒ‡ãƒ¢ SVG
$('#loadDemo').onclick = ()=>{
  showDiag();
  const demo = `<?xml version="1.0" encoding="UTF-8"?><svg viewBox="0 0 600 400" xmlns="http://www.w3.org/2000/svg">
   <rect width="100%" height="100%" fill="#eef2ff"/>
   <g id="åŒ—æµ·é“"><path d="M60,60 L160,40 L200,80 L160,120 L80,120 Z" fill="#c7d2fe" stroke="#334155"/></g>
   <g id="æ²–ç¸„çœŒ"><circle cx="520" cy="340" r="18" fill="#c7d2fe" stroke="#334155"/></g>
   <g id="æ±äº¬éƒ½"><rect x="320" y="200" width="24" height="24" fill="#c7d2fe" stroke="#334155"/></g>
   <text x="70" y="30" font-size="14">ï¼ˆãƒ‡ãƒ¢ï¼‰ã–ã£ãã‚Šé…ç½®</text>
  </svg>`;
  loadSVGText(demo);
};

// ===== UI åˆæœŸåŒ– =====
$('#wsApply').onclick = ()=>{
  const v=$('#wsInput').value.trim(); if(!v){ toast('WS URL ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  try{
    const u = new URL(v);
    if(u.protocol!== 'ws:' && u.protocol!=='wss:'){ toast('WS URL ã¯ ws:// ã¾ãŸã¯ wss://'); return; }
  }catch(_){ toast('WS URL ãŒä¸æ­£ã§ã™'); return; }
  wsUrl=v; $('#wsUrl').textContent=v; connect(); showDiag();
};

$('#joinBtn').onclick = async ()=>{
  me.name=$('#name').value||`player_${Math.random().toString(36).slice(2,6)}`;
  me.room=$('#room').value||'room1';
  $('#roomLabel').textContent=me.room; state.mode='multi'; showDiag();
  // æ¥ç¶šãŒç„¡ã‘ã‚Œã°æ¥ç¶š (wss æ¨å¥¨ãƒã‚§ãƒƒã‚¯)
  if(location.protocol==='https:' && !/^wss:\/\//.test(wsUrl)){
    $('#secureHint').textContent = 'ï¼ˆHTTPSã§ã¯ wss:// ã‚’æ¨å¥¨ï¼‰';
  }
  if(!ws || !wsOpen){ connect(); }
  await wsReady; // open å¾…ã¡
  sendSafe({type:'join', room:me.room, name:me.name});
  updateButtons();
};

$('#startBtn').onclick = ()=>{ if(state.mode==='solo') startSolo(); else startMulti(); };
$('#soloBtn').onclick = ()=>{ state.mode='solo'; $('#connState').textContent = 'ã‚½ãƒ­'; toast('ã‚½ãƒ­ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰'); updateButtons(); if(state.svgLoaded) startSolo(); };

// URL ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§è‡ªå‹• join
(function(){ const u=new URL(location.href); const room=u.searchParams.get('room'); const name=u.searchParams.get('name'); const wsx=u.searchParams.get('ws'); if(wsx){ $('#wsInput').value=wsx; $('#wsApply').click(); }
  if(room){ $('#room').value=room; } if(name){ $('#name').value=name; }
  if(room||name){ $('#joinBtn').click(); }
})();

// ã‚¹ã‚³ã‚¢æç”»
function renderScores(){
  const tb = $('#scoreTable tbody'); tb.innerHTML='';
  Object.entries(state.scores).sort((a,b)=>b[1]-a[1]).forEach(([name,sc])=>{
    const tr=document.createElement('tr'); tr.innerHTML=`<td>${name}</td><td class="score">${sc}</td>`; tb.appendChild(tr);
  });
}

// ===== ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ =====
$('#tDemo').onclick = ()=>{ $('#loadDemo').click(); toast('[TC1] OK: ãƒ‡ãƒ¢èª­ã¿è¾¼ã¿'); };
$('#tPdf').onclick = ()=>{ showDiag(); const fakePdf = '%PDF-1.7\n...'; if(/^%PDF-/.test(fakePdf)){ toast('[TC2] OK: PDFæ¤œå‡ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º'); log('TC2: detected PDF header (sim)'); } };
$('#tWsUrl').onclick = ()=>{ showDiag(); const bad='http://example.com'; $('#wsInput').value=bad; $('#wsApply').click(); };
$('#tJoinEarly').onclick = ()=>{ showDiag(); me.name='earlyUser'; me.room='t'; state.mode='multi'; sendSafe({type:'join', room:'t', name:'earlyUser'}); toast('[TC4] OK: æ¥ç¶šå‰ã«joinâ†’ã‚­ãƒ¥ãƒ¼'); };

</script>

<!-- ====== åŒæ¢±ç”¨ï¼šNode WebSocket ã‚µãƒ¼ãƒï¼ˆserver.jsï¼‰ ======
ä¿å­˜å: server.js

const http = require('http');
const WebSocket = require('ws');
const server = http.createServer();
const wss = new WebSocket.Server({ server });

const rooms = new Map(); // roomId -> { players: Map(ws -> {id,name,score}), questions:[], turn:0 }

function broadcast(roomId, data){ const room=rooms.get(roomId); if(!room) return; const msg=JSON.stringify(data);
  for(const ws of room.players.keys()){ if(ws.readyState===1){ ws.send(msg); } }
}
function normName(s){ return (s||'').replace(/\s+/g,'').replace(/[éƒ½é“åºœçœŒåºœ ]/g,''); }
function makeQuestions(prefList, n=10){ const arr=[...prefList]; for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr.slice(0, Math.min(n, arr.length)); }

let nextId = 1;

wss.on('connection', (ws)=>{
  ws.on('message', (data)=>{
    let msg={}; try{ msg = JSON.parse(data); }catch(_){ return; }
    if(msg.type==='join'){
      const roomId = msg.room || 'room1';
      const name = (msg.name || `player_${Math.random().toString(36).slice(2,6)}`).slice(0,20);
      if(!rooms.has(roomId)) rooms.set(roomId, { players: new Map(), questions: [], turn:0 });
      const room = rooms.get(roomId);
      const id = nextId++;
      room.players.set(ws, { id, name, score:0 });
      ws._roomId = roomId; ws._id = id; ws._name = name;
      const scores = {}; for(const p of room.players.values()){ scores[p.name]=p.score; }
      ws.send(JSON.stringify({ type:'joined', id, players: room.players.size, scores }));
      broadcast(roomId, { type:'players', players: room.players.size, scores });
    }
    else if(msg.type==='start'){
      const roomId = msg.room; const room = rooms.get(roomId); if(!room) return;
      const baseList = ['åŒ—æµ·é“','é’æ£®çœŒ','å²©æ‰‹çœŒ','å®®åŸçœŒ','ç§‹ç”°çœŒ','å±±å½¢çœŒ','ç¦å³¶çœŒ','èŒ¨åŸçœŒ','æ ƒæœ¨çœŒ','ç¾¤é¦¬çœŒ','åŸ¼ç‰çœŒ','åƒè‘‰çœŒ','æ±äº¬éƒ½','ç¥å¥ˆå·çœŒ','æ–°æ½ŸçœŒ','å¯Œå±±çœŒ','çŸ³å·çœŒ','ç¦äº•çœŒ','å±±æ¢¨çœŒ','é•·é‡çœŒ','å²é˜œçœŒ','é™å²¡çœŒ','æ„›çŸ¥çœŒ','ä¸‰é‡çœŒ','æ»‹è³€çœŒ','äº¬éƒ½åºœ','å¤§é˜ªåºœ','å…µåº«çœŒ','å¥ˆè‰¯çœŒ','å’Œæ­Œå±±çœŒ','é³¥å–çœŒ','å³¶æ ¹çœŒ','å²¡å±±çœŒ','åºƒå³¶çœŒ','å±±å£çœŒ','å¾³å³¶çœŒ','é¦™å·çœŒ','æ„›åª›çœŒ','é«˜çŸ¥çœŒ','ç¦å²¡çœŒ','ä½è³€çœŒ','é•·å´çœŒ','ç†Šæœ¬çœŒ','å¤§åˆ†çœŒ','å®®å´çœŒ','é¹¿å…å³¶çœŒ','æ²–ç¸„çœŒ'];
      room.questions = makeQuestions(baseList, 10);
      room.turn = 0;
      broadcast(roomId, { type:'start', questions: room.questions });
    }
    else if(msg.type==='click'){
      const roomId = msg.room; const room = rooms.get(roomId); if(!room) return; const p = room.players.get(ws); if(!p) return;
      const current = room.questions[room.turn]; if(!current) return;
      const good = normName(msg.answer) === normName(current);
      if(good){ p.score += 1; room.turn += 1; const next = room.questions[room.turn];
        broadcast(roomId, { type:'click-result', name:p.name, clickedId: msg.answer, correct: true, turn: room.turn, next });
        const scores = {}; for(const q of room.players.values()){ scores[q.name]=q.score; }
        broadcast(roomId, { type:'scores', scores });
      } else {
        ws.send(JSON.stringify({ type:'click-result', name:p.name, clickedId: msg.answer, correct: false, turn: room.turn }));
      }
    }
  });
  ws.on('close', ()=>{
    const roomId=ws._roomId; const room = rooms.get(roomId); if(!room) return;
    room.players.delete(ws);
    const scores = {}; for(const p of room.players.values()){ scores[p.name]=p.score; }
    broadcast(roomId, { type:'players', players: room.players.size, scores });
  });
});

const PORT = process.env.PORT || 3000;
server.listen(PORT, ()=>console.log(`WS server listening on ${PORT}`));
// ====== server.js ã“ã“ã¾ã§ ======
-->

</body>
</html>
