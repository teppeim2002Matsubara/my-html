
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å¯¾æˆ¦ | éƒ½é“åºœçœŒãƒãƒˆãƒ«</title>
  <style>
    :root{ --line:#e5e7eb; --muted:#6b7280; }
    html,body{margin:0;height:100%;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN",Meiryo,sans-serif}
    header{display:flex;gap:12px;align-items:center;padding:10px 14px;border-bottom:1px solid var(--line);position:sticky;top:0;background:#fff;z-index:10}
    .brand{font-weight:700}
    .pill{display:inline-flex;gap:6px;align-items:center;background:#f3f4f6;border-radius:999px;padding:4px 8px;font-size:12px}
    .wrap{max-width:1100px;margin:0 auto;padding:12px 14px}
    .bar{display:flex;gap:10px;align-items:center;justify-content:space-between;border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff;position:sticky;top:58px;z-index:9}
    .bar h2{margin:0;font-size:18px}
    .scores{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .score-pill{display:inline-flex;gap:6px;align-items:center;padding:6px 8px;border:1px solid var(--line);border-radius:999px;font-size:13px}
    .mapwrap{border:1px solid var(--line);border-radius:12px;background:#f9fafb;overflow:hidden;min-height:60vh;margin-top:8px}
    #mapMeta{padding:10px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    #mapContainer{width:100%;height:72vh;display:grid;place-items:center}
    svg{width:100%;height:100%}
    .btn{border:1px solid var(--line);border-radius:10px;padding:8px 10px;background:#fff;cursor:pointer}
    .btn.primary{background:#111827;color:#fff;border-color:#111827}
    .hint{color:var(--muted);font-size:12px}
    /* åè»¢ã‚’æ‹›ãã‚°ãƒ­ãƒ¼ãƒãƒ« fill æŒ‡å®šã¯ç½®ã‹ãªã„ã€‚æ­£è§£æ™‚ã ã‘ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ fill ã‚’è¨­å®š */
    .highlight-wrong{stroke:#ef4444 !important;stroke-width:2}
  </style>
</head>
<body>
  <header>
    <div class="brand">ğŸ—¾ éƒ½é“åºœçœŒãƒãƒˆãƒ«</div>
    <span class="pill">çŠ¶æ…‹: <b id="conn">æ¥ç¶šæº–å‚™</b></span>
    <span class="pill">ãƒ«ãƒ¼ãƒ : <b id="roomLabel">-</b></span>
    <span class="pill">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼: <b id="playersCount">0</b></span>
    <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
      <label class="hint" for="modeSelect">ãƒ¢ãƒ¼ãƒ‰</label>
      <select id="modeSelect" style="border:1px solid var(--line);border-radius:10px;padding:6px 8px">
        <option value="random" selected>ãƒ©ãƒ³ãƒ€ãƒ  (15å•)</option>
        <option value="all">å…¨å• (47å•)</option>
      </select>
      <button class="btn" id="soloBtn">ã‚½ãƒ­ç·´ç¿’</button>
      <button class="btn primary" id="startBtn" disabled>å¯¾æˆ¦ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
    </div>
  </header>

  <main class="wrap">
    <!-- å•é¡Œãƒãƒ¼ï¼ˆåœ°å›³ã®ã™ãä¸Šï¼‰ -->
    <div class="bar" id="questionBar">
      <h2>Q: <span id="question">ï¼ˆèª­ã¿è¾¼ã¿å¾…ã¡ï¼‰</span></h2>
      <div style="display:flex;gap:8px;align-items:center">
        <span>ã‚¿ãƒ¼ãƒ³ <b id="turn">0</b>/<b id="turnMax">0</b></span>
        <button class="btn" id="skipBtn">ã‚¹ã‚­ãƒƒãƒ—â–¶</button>
      </div>
    </div>

    <!-- ã‚¹ã‚³ã‚¢ãƒãƒ¼ï¼ˆå•é¡Œã®ç›´ä¸‹ / åœ°å›³ã®ç›´ä¸Šï¼‰ -->
    <div class="bar" id="scoreBar">
      <div class="scores" id="scoresPills"></div>
      <div class="hint">SVG ã‚’èª­ã¿è¾¼ã‚“ã§ã‚¹ã‚¿ãƒ¼ãƒˆ â†’ ã‚½ãƒ­/å¯¾æˆ¦</div>
    </div>

    <!-- åœ°å›³ -->
    <div class="mapwrap">
      <div id="mapMeta">
        <input type="file" id="svgFile" accept="image/svg+xml">
        <button class="btn" id="loadDemo">ãƒ‡ãƒ¢SVG</button>
        <button class="btn" id="fetchShared">å…±æœ‰åœ°å›³ã‚’èª­ã¿è¾¼ã‚€</button>

        <details>
          <summary class="hint">WS è¨­å®š</summary>
          <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
            <input id="wsInput" size="34">
            <button class="btn" id="wsApply">é©ç”¨</button>
            <span class="hint">ç¾åœ¨: <code id="wsUrl">-</code></span>
          </div>
        </details>
      </div>
      <div id="mapContainer"><div class="hint">å·¦ä¸Šã§ SVG ã‚’èª­ã¿è¾¼ã¿</div></div>
    </div>
  </main>

<script>
// ===== util =====
const $ = (s)=>document.querySelector(s);
function normName(s){ return (s||'').replace(/\s+/g,'').replace(/[éƒ½é“åºœçœŒåºœ ]/g,''); }
function getDisplayName(el){
  if(!el) return '';
  const t = el.getAttribute('data-name') || el.getAttribute('aria-label') || el.getAttribute('inkscape:label') || (el.querySelector && el.querySelector('title') && el.querySelector('title').textContent) || el.id || '';
  return t.trim();
}

// =====  =====
let ws=null; let wsUrl='';
let me={ id:null, name:'', room:'', color:'#22c55e' };
let state={ mode:'multi', questionList:[], turn:0, turnMax:10, current:null, scores:{}, playerColors:{}, clickable:true, svgDoc:null, prefectures:[], svgLoaded:false };
function updateButtons(){ const ok = state.svgLoaded && (state.mode==='solo' || (ws && ws.readyState===1)); $('#startBtn').disabled=!ok; }

// ===== connection =====
function connect(){
  if(ws){ try{ ws.close(); }catch(e){} }
  ws = new WebSocket(wsUrl);
  $('#connState').textContent='æ¥ç¶šä¸­â€¦';
  ws.onopen=()=>{ $('#connState').textContent='ã‚ªãƒ³ãƒ©ã‚¤ãƒ³'; if(me.room&&me.name){ send({type:'join', room:me.room, name:me.name, color:me.color}); } updateButtons(); };
  ws.onclose=()=>{ $('#connState').textContent='ã‚ªãƒ•ãƒ©ã‚¤ãƒ³'; updateButtons(); };
  ws.onerror=()=>{ $('#connState').textContent='ã‚¨ãƒ©ãƒ¼'; updateButtons(); };
  ws.onmessage=(ev)=>{ const msg=JSON.parse(ev.data); switch(msg.type){
    case 'joined': me.id=msg.id; $('#playersCount').textContent=msg.players; state.scores=msg.scores||{}; if(msg.colors) state.playerColors=msg.colors; renderScores(); break;
    case 'players': $('#playersCount').textContent=msg.players; state.scores=msg.scores||{}; if(msg.colors) state.playerColors=msg.colors; renderScores(); break;
    case 'start':
      state.mode = 'multi';
      state.questionList = msg.questions;
      state.turn = 0;
      state.turnMax = msg.total || msg.questions.length; // â˜…ã“ã“ãƒã‚¤ãƒ³ãƒˆ
      resetColors();
      state.scores = msg.scores || {};
      renderScores();
      nextQuestion();
      document.getElementById('turnMax').textContent = state.turnMax;
      break;


    case 'click-result': showClickResult(msg); break;
    case 'advance': state.turn=msg.turn; setQuestion(msg.question); $('#turn').textContent=(state.turn+1); break;
    case 'scores': state.scores=msg.scores||{}; if(msg.colors) state.playerColors=msg.colors; renderScores(); break;
  }};
}
function send(o){ if(ws && ws.readyState===1) ws.send(JSON.stringify(o)); }

// ===== game =====
function setQuestion(name){ state.current=name; $('#question').textContent=name||'ï¼ˆå•é¡Œãªã—ï¼‰'; }
function nextQuestion(){ if(state.turn>=state.turnMax){ setQuestion('çµ‚äº†ï¼'); state.clickable=false; return; } const q=state.questionList[state.turn]; setQuestion(q); $('#turn').textContent=(state.turn+1); }
function startSolo(){ state.mode='solo'; if(!state.prefectures.length){ alert('å…ˆã«SVG'); return; } const pref=[ 'åŒ—æµ·é“','é’æ£®çœŒ','å²©æ‰‹çœŒ','å®®åŸçœŒ','ç§‹ç”°çœŒ','å±±å½¢çœŒ','ç¦å³¶çœŒ','èŒ¨åŸçœŒ','æ ƒæœ¨çœŒ','ç¾¤é¦¬çœŒ','åŸ¼ç‰çœŒ','åƒè‘‰çœŒ','æ±äº¬éƒ½','ç¥å¥ˆå·çœŒ','æ–°æ½ŸçœŒ','å¯Œå±±çœŒ','çŸ³å·çœŒ','ç¦äº•çœŒ','å±±æ¢¨çœŒ','é•·é‡çœŒ','å²é˜œçœŒ','é™å²¡çœŒ','æ„›çŸ¥çœŒ','ä¸‰é‡çœŒ','æ»‹è³€çœŒ','äº¬éƒ½åºœ','å¤§é˜ªåºœ','å…µåº«çœŒ','å¥ˆè‰¯çœŒ','å’Œæ­Œå±±çœŒ','é³¥å–çœŒ','å³¶æ ¹çœŒ','å²¡å±±çœŒ','åºƒå³¶çœŒ','å±±å£çœŒ','å¾³å³¶çœŒ','é¦™å·çœŒ','æ„›åª›çœŒ','é«˜çŸ¥çœŒ','ç¦å²¡çœŒ','ä½è³€çœŒ','é•·å´çœŒ','ç†Šæœ¬çœŒ','å¤§åˆ†çœŒ','å®®å´çœŒ','é¹¿å…å³¶çœŒ','æ²–ç¸„çœŒ' ]; const allow=new Set(pref.map(n=>normName(n))); const names=state.prefectures.map(el=>getDisplayName(el)).filter(n=>allow.has(normName(n))); state.questionList=shuffle(names).slice(0,Math.min(15,names.length)); state.turn=0; state.turnMax=state.questionList.length; $('#turnMax').textContent=state.turnMax; state.scores={}; renderScores(); clearMarks(); state.clickable=true; nextQuestion(); updateButtons(); }
function startMulti() {
  state.mode = 'multi';
  const sel = document.getElementById('modeSelect');
  const urlMode = new URL(location.href).searchParams.get('mode');
  const mode = (sel && sel.value) || (urlMode === 'all' ? 'all' : 'random'); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ random

  console.log('[CLIENT] send start:', { room: me.room, mode }); // â˜… é€ä¿¡å‰ãƒ­ã‚°
  send({ type: 'start', room: me.room, mode });
}
function updateButtons() {
  const ok = state.svgLoaded && (state.mode === 'solo' || (ws && ws.readyState === 1));
  document.getElementById('startBtn').disabled = !ok;
}

// --- SVG èª­ã¿è¾¼ã¿å®Œäº†æ™‚ ---
function onSvgLoaded() {
  state.svgLoaded = true;
  updateButtons();   // â˜…ã“ã“ã§å‘¼ã¶
}

// --- WebSocket æ¥ç¶šå®Œäº†æ™‚ ---
function onWsOpen() {
  console.log('[CLIENT] WS connected');
  updateButtons();   // â˜…ã“ã“ã§ã‚‚å‘¼ã¶
}

function onMapClick(target){ if(!state.clickable||!state.current) return; const clickedId=(target.id||'').trim(); const clickedName=getDisplayName(target); if(!clickedId&&!clickedName){ return; } const good=normName(clickedName)===normName(state.current); if(state.mode==='solo'){ if(good){ colorize(target, me.color||'#22c55e'); state.turn++; nextQuestion(); } else { flashWrong(target); } } else { send({ type:'click', room:me.room, id:me.id, name:me.name, color:me.color, answer:clickedName, answerName:clickedName, answerId:clickedId }); } }

function showClickResult(msg){ if(!state.svgDoc) return; let el=null; if(msg.clickedId) el=state.svgDoc.getElementById(msg.clickedId); if(!el && msg.answer){ const t=msg.answer; el=state.prefectures.find(n=>normName(getDisplayName(n))===normName(t)); } if(!el) return; if(msg.correct){ const col=msg.color || state.playerColors[msg.name] || '#22c55e'; colorize(el,col); } else { flashWrong(el); } if(msg.next){ state.turn=msg.turn; setQuestion(msg.next); $('#turn').textContent=(state.turn+1); } }

// ===== SVG helpers =====
function attachHandlersToSVG(root){
  const sels=['path','polygon','rect','circle','ellipse','g'];
  const els=[];
  const recordOrig = (node)=>{
    if(node && node.dataset){
      if(node.dataset.origFill === undefined){
        const attrFill = node.getAttribute('fill');
        node.dataset.origFill = (attrFill!=null? attrFill : '');
      }
    }
  };
  sels.forEach(s=> root.querySelectorAll(s).forEach(el=>{
    if(el.id){
      // ã‚¯ãƒªãƒƒã‚¯ç™»éŒ²
      els.push(el); el.classList.add('hoverable');
      el.addEventListener('click',e=>{ e.stopPropagation(); onMapClick(el); }, false);
      // å¡—ã‚Šå¯¾è±¡ãƒãƒ¼ãƒ‰ã®å…ƒè‰²ã‚’ä¿å­˜
      const tag=(el.tagName||'').toLowerCase();
      const targets=(tag==='g')? el.querySelectorAll('path,polygon,rect,circle,ellipse') : [el];
      targets.forEach(recordOrig);
    }
  }));
  state.prefectures=els; state.svgLoaded=true; updateButtons();
}
function forEachPaintTarget(el, cb){ const tag=(el.tagName||'').toLowerCase(); const targets=(tag==='g')? el.querySelectorAll('path,polygon,rect,circle,ellipse') : [el]; targets.forEach(cb); }
function colorize(el, color){ forEachPaintTarget(el, node=>{ if(color){ node.style.fill=color; node.setAttribute('fill',color); } node.classList.remove('highlight-wrong'); }); }
function resetColors(){
  const restoreNode = (node)=>{
    if(node && node.dataset && node.dataset.origFill !== undefined){
      const orig = node.dataset.origFill;
      node.style.fill='';
      if(orig===''){ node.removeAttribute('fill'); } else { node.setAttribute('fill', orig); }
    } else {
      node.style.fill=''; node.removeAttribute('fill');
    }
    node.classList.remove('highlight-wrong');
  };
  state.prefectures.forEach(el=>{
    const tag=(el.tagName||'').toLowerCase();
    const targets=(tag==='g')? el.querySelectorAll('path,polygon,rect,circle,ellipse') : [el];
    targets.forEach(restoreNode);
  });
}
function clearMarks(){ resetColors(); }
function flashWrong(el){ forEachPaintTarget(el, node=>{ node.classList.add('highlight-wrong'); setTimeout(()=>node.classList.remove('highlight-wrong'),500); }); }
function shuffle(a){ const arr=[...a]; for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }

// ===== UI init =====
document.getElementById('fetchShared').onclick = async () => {
  try {
    const res = await fetch('/map.svg', { cache: 'no-store' });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const text = await res.text();
    loadSVG(text);            // â† æ—¢ã«ã‚ã‚‹SVGèª­ã¿è¾¼ã¿é–¢æ•°ã‚’å‘¼ã¶
    state.svgShared = true;
    console.log('[CLIENT] shared map loaded');
  } catch (e) {
    alert('å…±æœ‰åœ°å›³ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
  }
};

$('#skipBtn').onclick=()=>{ if(state.mode==='solo'){ state.turn++; nextQuestion(); } else { send({type:'skip', room:me.room, id:me.id, name:me.name}); } };
$('#soloBtn').onclick=()=>{ state.mode='solo'; $('#connState').textContent='ã‚½ãƒ­'; if(state.svgLoaded) startSolo(); };
$('#startBtn').onclick = () => {
  console.log('[CLIENT] startBtn clicked');  // â†ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã‹ç¢ºèª
  if (state.mode === 'solo') {
    console.log('[CLIENT] solo mode start');
    startSolo();
  } else {
    console.log('[CLIENT] multi mode start');
    startMulti();
  }
};
$('#svgFile').addEventListener('change', async(ev)=>{ const f=ev.target.files[0]; if(!f) return; const text=await f.text(); if(/^%PDF-/.test(text.slice(0,8))){ alert('PDFã¯ç›´æ¥èª­ã‚ã¾ã›ã‚“ã€‚SVGã¸å¤‰æ›ã‚’ã€‚'); return; } loadSVG(text); });
$('#loadDemo').onclick=()=>{ const demo=`<?xml version="1.0" encoding="UTF-8"?><svg viewBox="0 0 600 400" xmlns="http://www.w3.org/2000/svg"><rect width="100%" height="100%" fill="#eef2ff"/><g id="åŒ—æµ·é“" data-name="åŒ—æµ·é“"><path d="M60,60 L160,40 L200,80 L160,120 L80,120 Z" fill="#c7d2fe" stroke="#334155"/></g><g id="æ²–ç¸„çœŒ" data-name="æ²–ç¸„çœŒ"><circle cx="520" cy="340" r="18" fill="#c7d2fe" stroke="#334155"/></g><g id="æ±äº¬éƒ½" data-name="æ±äº¬éƒ½"><rect x="320" y="200" width="24" height="24" fill="#c7d2fe" stroke="#334155"/></g><text x="70" y="30" font-size="14">ï¼ˆãƒ‡ãƒ¢ï¼‰ã–ã£ãã‚Šé…ç½®</text></svg>`; loadSVG(demo); };

function loadSVG(text){ const parser=new DOMParser(); const doc=parser.parseFromString(text,'image/svg+xml'); const svg=doc.querySelector('svg'); if(!svg){ alert('SVGã‚¿ã‚°ãªã—'); return; } $('#mapContainer').innerHTML=''; const imported=document.importNode(svg,true); $('#mapContainer').appendChild(imported); state.svgDoc=imported; attachHandlersToSVG(imported); $('#question').textContent='ï¼ˆæº–å‚™OKï¼šé–‹å§‹ã—ã¦ä¸‹ã•ã„ï¼‰'; updateButtons(); }

// ===== boot from URL =====
(function(){ const u=new URL(location.href); me.name=u.searchParams.get('name')||''; me.room=u.searchParams.get('room')||'room1'; me.color=u.searchParams.get('color')||'#22c55e'; wsUrl=u.searchParams.get('ws')||'wss://calisthenical-migdalia-cousinly.ngrok-free.dev'; $('#wsInput').value=wsUrl; $('#wsUrl').textContent=wsUrl; $('#roomLabel').textContent=me.room; connect(); })();

// WS URL apply
$('#wsApply').onclick=()=>{ const v=$('#wsInput').value.trim(); try{ const u=new URL(v); if(u.protocol!=='ws:'&&u.protocol!=='wss:') throw new Error('bad'); }catch(e){ alert('ws:// ã¾ãŸã¯ wss:// ã§å…¥åŠ›'); return; } wsUrl=v; $('#wsUrl').textContent=v; connect(); };

function renderScores(){ const box=$('#scoresPills'); box.innerHTML=''; const entries=Object.entries(state.scores).sort((a,b)=>b[1]-a[1]); entries.forEach(([name,sc])=>{ const col=state.playerColors[name]||'#22c55e'; const pill=document.createElement('span'); pill.className='score-pill'; pill.innerHTML=`<span style="display:inline-block;width:12px;height:12px;border-radius:50%;border:1px solid var(--line);background:${col}"></span>${name}: <b>${sc}</b>`; box.appendChild(pill); }); }
</script>
</body>
</html>
