<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Clock + Weather + MBTA (Next 3)</title>
<style>
  *{box-sizing:border-box}
  html,body{margin:0;padding:0}
  body{
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    background:#0b0b0f; color:#f5f5f7;
    min-height:100vh; display:grid; grid-template-rows:auto 1fr; gap:16px;
  }
  header{padding:12px 14px; display:grid; place-items:center}
  .row{display:flex; gap:16px; flex-wrap:wrap; align-items:center; justify-content:center}
  .card{background:#14141a; border-radius:16px; padding:14px}
  .label{color:#b8b8c2; font-size:.85rem}
  .digital{font-size:2.1rem; font-weight:800}
  .note{color:#b8b8c2; font-size:1.1rem}
  .small{color:#c9c9d4; font-size:.9rem}
  .ok{color:#81f481}
  .warn{color:#ffd166}
  .bad{color:#ff6b6b}
  .cd{font-weight:bold}
  .cd.gray{color:#aaa}
  .cd.red{color:#ff6b6b}
  .cd.yellow{color:#ffd166}
  .cd.white{color:#fff}

  /* Clock container */
  .clock-box{position:relative; width:320px; height:320px}
  .bezel{position:absolute; inset:0; border-radius:50%; border:12px solid #000; background:#fff; overflow:hidden}
  svg#face{position:absolute; inset:0; display:block}

  /* Weather */
  .grid{display:grid; gap:14px; padding:0 14px 18px}
  .cols{grid-template-columns: repeat(auto-fit, minmax(300px, 1fr))}
  .wx-head{display:flex; align-items:center; justify-content:space-between; gap:10px}
  .pill{padding:6px 10px; border-radius:999px; background:rgba(255,255,255,.08); font-size:.9rem; font-weight:700}
  .list{display:grid; grid-auto-rows:minmax(34px,auto); gap:6px; max-height:none; overflow:visible; padding-right:6px}
  .rowline{display:grid; grid-template-columns:64px 1fr auto; align-items:center; gap:10px; padding:8px 10px; border-radius:10px; background:rgba(255,255,255,.05)}
  .rowline.active{background:rgba(128,128,128,0.35)}
  .wx{display:inline-flex; align-items:center; gap:8px}
  .emoji{font-size:1.15rem}

  /* Next trains */
  .next-box{min-width:320px}
  .next-list{display:grid; gap:8px}
  .train{display:grid; grid-template-columns:90px 1fr auto; gap:10px; align-items:center; padding:10px 12px; border-radius:12px; background:#1a1a22}
  .lh{line-height:1.25}
  .route{font-weight:700}
</style>
</head>
<body>
  <header>
    <div class="row">
      <div class="card">
        <div class="clock-box">
          <div class="bezel"></div>
          <svg id="face" viewBox="0 0 320 320" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <!-- hands -->
            <line id="hHand" x1="160" y1="160" x2="160" y2="95" stroke="#000" stroke-width="12" stroke-linecap="round"/>
            <line id="mHand" x1="160" y1="160" x2="160" y2="70" stroke="#000" stroke-width="6"  stroke-linecap="round"/>
            <line id="sHand" x1="160" y1="160" x2="160" y2="60" stroke="#e00000" stroke-width="2" stroke-linecap="round"/>
            <circle cx="160" cy="160" r="8" fill="#fff" stroke="#e00000" stroke-width="3"/>
          </svg>
        </div>
      </div>
      <div class="card">
        <div class="digital" id="digitalLocal">--:--</div>
        <div class="note" id="dateLocal"></div>
        <div class="small" id="tzLabel">America/New_York</div>
      </div>
      <div class="card">
        <div class="digital" id="digitalJP">--:--</div>
        <div class="note" id="dateJP"></div>
        <div class="small">Asia/Tokyo</div>
      </div>
      <div class="card next-box">
        <div class="wx-head">
          <div class="label">Next Trains — per line (3 each) — West Medford / Porter </div>
          <div class="pill" id="asOf">as of --:--</div>
        </div>
        <div class="next-list" id="next3">
          <div class="small">Loading trains…</div>
        </div>
      </div>
    </div>
  </header>

  <section class="grid cols">
    <div class="card">
      <div class="wx-head">
        <div class="label">Today (Boston)</div>
        <div class="pill" id="minmaxToday">Today: -- / -- °C</div>
      </div>
      <div class="list" id="hourly12"></div>
    </div>

    <div class="card">
      <div class="wx-head">
        <div class="label">Tomorrow (Boston)</div>
        <div class="pill" id="minmaxTomorrow">-- / -- °C</div>
      </div>
      <div class="list" id="tomorrowKey"></div>
    </div>
  </section>

<script>
  // ======== CLOCK (SVG face + hands) ========
  (function(){
    const svg = document.getElementById('face');
    const size = 320, c = size/2;
    const bezel = 12;
    const rOuter = c - bezel - 6;
    const lenMin = 10, lenHour = 18;
    const thickMin = 2, thickHour = 3;
    const rNum = rOuter - lenHour - 16;

    for(let i=0;i<60;i++){
      const ang = (i*Math.PI/30);
      const isHour = i%5===0;
      const r1 = rOuter - (isHour? lenHour : lenMin);
      const r2 = rOuter;
      const x1 = c + Math.cos(ang)*r1;
      const y1 = c + Math.sin(ang)*r1;
      const x2 = c + Math.cos(ang)*r2;
      const y2 = c + Math.sin(ang)*r2;
      const line = document.createElementNS('http://www.w3.org/2000/svg','line');
      line.setAttribute('x1', x1); line.setAttribute('y1', y1);
      line.setAttribute('x2', x2); line.setAttribute('y2', y2);
      line.setAttribute('stroke', '#000');
      line.setAttribute('stroke-width', isHour? thickHour : thickMin);
      line.setAttribute('stroke-linecap', 'butt');
      svg.insertBefore(line, document.getElementById('hHand'));
    }
    for (let i=1; i<=12; i++){
      const ang = (i-3) * (Math.PI/6);
      const x = c + Math.cos(ang)*rNum;
      const y = c + Math.sin(ang)*rNum;
      const text = document.createElementNS('http://www.w3.org/2000/svg','text');
      text.setAttribute('x', x);
      text.setAttribute('y', y+1);
      text.setAttribute('fill', '#000');
      text.setAttribute('font-weight', '800');
      text.setAttribute('font-size', '20');
      text.setAttribute('text-anchor', 'middle');
      text.setAttribute('dominant-baseline', 'middle');
      text.textContent = i;
      svg.insertBefore(text, document.getElementById('hHand'));
    }
  })();

  const pad=n=>String(n).padStart(2,'0');
  const fmtDate=(d,loc='en-US',tz)=>d.toLocaleString(loc,{weekday:'short',month:'numeric',day:'numeric',timeZone:tz});
  function setHand(id, angleDeg, length){
    const c=160; const rad=(angleDeg-90)*Math.PI/180; const x2=c+Math.cos(rad)*length; const y2=c+Math.sin(rad)*length; const line=document.getElementById(id); line.setAttribute('x1',c); line.setAttribute('y1',c); line.setAttribute('x2',x2); line.setAttribute('y2',y2);
  }
  function tick(){
    const now=new Date();
    const h=now.getHours()%12, m=now.getMinutes(), s=now.getSeconds();
    setHand('hHand',(h+m/60)*30,78); setHand('mHand',m*6,102); setHand('sHand',s*6,116);
    document.getElementById('digitalLocal').textContent=`${pad(now.getHours())}:${pad(m)}`;
    document.getElementById('dateLocal').textContent=fmtDate(now);
    const jp=new Date(now.toLocaleString('en-US',{timeZone:'Asia/Tokyo'}));
    document.getElementById('digitalJP').textContent=`${pad(jp.getHours())}:${pad(jp.getMinutes())}`;
    document.getElementById('dateJP').textContent=fmtDate(jp,'en-US','Asia/Tokyo');
    document.getElementById('asOf').textContent=`as of ${pad(now.getHours())}:${pad(now.getMinutes())}`;
  }
  tick(); setInterval(tick,1000);

  // ======== WEATHER (Open-Meteo) ========
  const LAT=42.3601, LON=-71.0589;
  const URL=`https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}&hourly=temperature_2m,precipitation,weathercode&daily=temperature_2m_max,temperature_2m_min,weathercode&timezone=auto&temperature_unit=celsius`;
  const codeToEmoji=(code)=>{
    if ([0].includes(code)) return "☀️ Clear";
    if ([1].includes(code)) return "🌤 Mostly clear";
    if ([2].includes(code)) return "⛅️ Partly cloudy";
    if ([3].includes(code)) return "☁️ Cloudy";
    if ([45,48].includes(code)) return "🌫 Fog";
    if ([51,53,55].includes(code)) return "🌦 Drizzle";
    if ([56,57].includes(code)) return "🌧 Freezing drizzle";
    if ([61,63,65].includes(code)) return "🌧 Rain";
    if ([66,67].includes(code)) return "🌧 Freezing rain";
    if ([71,73,75,77].includes(code)) return "🌨 Snow";
    if ([80,81,82].includes(code)) return "🌧 Showers";
    if ([85,86].includes(code)) return "🌨 Snow showers";
    if ([95].includes(code)) return "⛈ Thunderstorm";
    if ([96,99].includes(code)) return "⛈ Thunderstorm (hail)";
    return "🌡️ Weather";
  };
  async function loadWeather(){
    try{
      const r=await fetch(URL);
      if(!r.ok) throw new Error('weather '+r.status);
      const j=await r.json();
      const daily=j.daily;
      const todayMin=daily.temperature_2m_min?.[0];
      const todayMax=daily.temperature_2m_max?.[0];
      const tomorrowMin=daily.temperature_2m_min?.[1];
      const tomorrowMax=daily.temperature_2m_max?.[1];
      document.getElementById('minmaxToday').textContent=`Today: ${Math.round(todayMin)} / ${Math.round(todayMax)} °C`;
      document.getElementById('minmaxTomorrow').textContent=`${Math.round(tomorrowMin)} / ${Math.round(tomorrowMax)} °C`;

      const times=j.hourly.time||[];
      const temps=j.hourly.temperature_2m||[];
      const codes=j.hourly.weathercode||[];
      const precip=j.hourly.precipitation||[];
      const base=new Date();

      const todayList=document.getElementById('hourly12'); todayList.innerHTML='';
      const today=new Date(base); const y0=today.getFullYear(), m0=today.getMonth(), d0=today.getDate();
      ;[0,3,6,9,12,15,18,21].forEach(h=>{
        const target=new Date(y0,m0,d0,h,0,0); let bestI=-1, bestDiff=Infinity;
        for(let i=0;i<times.length;i++){ const dt=new Date(times[i]); if(dt.getDate()!==d0) continue; const diff=Math.abs(dt-target); if(diff<bestDiff){bestDiff=diff; bestI=i;} }
        if(bestI>=0){ const dt=new Date(times[bestI]); const line=document.createElement('div'); line.className='rowline'; const hour=dt.getHours(); if([9,12,15,18].includes(hour)) line.classList.add('active');
          const left=document.createElement('div'); left.className='note'; left.textContent=String(hour).padStart(2,'0')+':00';
          const mid=document.createElement('div'); mid.className='wx'; mid.textContent=codeToEmoji(codes[bestI]);
          const right=document.createElement('div'); right.innerHTML=`<strong>${Math.round(temps[bestI])}°C</strong>${(precip?.[bestI]??0)>0?` • ${precip[bestI]} mm`:''}`;
          line.appendChild(left); line.appendChild(mid); line.appendChild(right); todayList.appendChild(line);
        }
      });

      const tomorrowList=document.getElementById('tomorrowKey'); tomorrowList.innerHTML='';
      const tmr=new Date(base); tmr.setDate(base.getDate()+1); const y=tmr.getFullYear(), m=tmr.getMonth(), d=tmr.getDate();
      [0,3,6,9,12,15,18,21].forEach(h=>{
        const target=new Date(y,m,d,h,0,0); let bestI=-1, bestDiff=Infinity;
        for(let i=0;i<times.length;i++){ const dt=new Date(times[i]); if(dt.getDate()!==d) continue; const diff=Math.abs(dt-target); if(diff<bestDiff){bestDiff=diff; bestI=i;} }
        if(bestI>=0){ const dt=new Date(times[bestI]); const line=document.createElement('div'); line.className='rowline'; const hour=dt.getHours(); if([9,12,15,18].includes(hour)) line.classList.add('active');
          const left=document.createElement('div'); left.className='note'; left.textContent=String(hour).padStart(2,'0')+':00';
          const mid=document.createElement('div'); mid.className='wx'; mid.textContent=codeToEmoji(codes[bestI]);
          const right=document.createElement('div'); right.innerHTML=`<strong>${Math.round(temps[bestI])}°C</strong>${(precip?.[bestI]??0)>0?` • ${precip[bestI]} mm`:''}`;
          line.appendChild(left); line.appendChild(mid); line.appendChild(right); tomorrowList.appendChild(line);
        }
      });
    }catch(e){ document.getElementById('hourly12').innerHTML='<div class="note">Failed to load weather.</div>'; console.error(e); }
  }
  loadWeather(); setInterval(loadWeather, 15*60*1000);

  // ======== MBTA (next 3 across two lines) ========
  const MBTA_BASE='https://api-v3.mbta.com';
  const DEFAULT_KEY='d51c0048255e4bc0b5566d25c619a8a4';
  let API_KEY=localStorage.getItem('mbta_api_key')||DEFAULT_KEY;

  function setApiKey(k){ API_KEY=k||''; localStorage.setItem('mbta_api_key', API_KEY); }
  async function api(path){ const headers = API_KEY ? { 'x-api-key': API_KEY } : {}; const r = await fetch(`${MBTA_BASE}${path}`, { headers }); if(!r.ok){ const txt=await r.text().catch(()=> ''); throw new Error(`MBTA API ${r.status} ${r.statusText} ${txt}`);} return r.json(); }
  function nyToday(){ return new Date(new Date().toLocaleString('en-US',{ timeZone:'America/New_York' })); }
  function todayYMD(){ const d=nyToday(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
  async function getInboundDirId(routeId){ try{ const r=await api(`/routes/${encodeURIComponent(routeId)}`); const names=r?.data?.attributes?.direction_names||[]; const idx=names.findIndex(s=>String(s).toLowerCase()==='inbound'); if(idx===0||idx===1) return idx; }catch(e){} return 1; }
  async function findStopIdForRoute(routeId, aliases){
    const data=await api(`/stops?filter[route]=${encodeURIComponent(routeId)}&page[limit]=400`);
    const list=data.data||[]; const childFirst=(a,b)=>((a.attributes?.parent_station?0:1)-(b.attributes?.parent_station?0:1));
    for(const nm of aliases){ const hit=list.filter(s=>s.attributes?.name===nm).sort(childFirst)[0]; if(hit) return hit.id; }
    for(const nm of aliases){ const hit=list.filter(s=>(s.attributes?.name||'').toLowerCase().includes(nm.toLowerCase())).sort(childFirst)[0]; if(hit) return hit.id; }
    const all=await api(`/stops?filter[route_type]=2&page[limit]=800`); const allList=all.data||[];
    for(const nm of aliases){ const hit=allList.filter(s=>s.attributes?.name===nm).sort(childFirst)[0]; if(hit) return hit.id; }
    for(const nm of aliases){ const hit=allList.filter(s=>(s.attributes?.name||'').toLowerCase().includes(nm.toLowerCase())).sort(childFirst)[0]; if(hit) return hit.id; }
    throw new Error('stop not found');
  }
  async function fetchInboundRows(stopId, routeId){
    const date=todayYMD(); const inbound=await getInboundDirId(routeId); const tryDirs=[inbound, inbound===0?1:0]; let rows=[];
    for(const dir of tryDirs){
      const json=await api(`/schedules?filter[stop]=${encodeURIComponent(stopId)}&filter[route]=${encodeURIComponent(routeId)}&filter[direction_id]=${dir}&filter[date]=${date}&include=trip,route&sort=departure_time&page[limit]=300`);
      const trips=new Map(); const routes=new Map(); (json.included||[]).forEach(it=>{ if(it.type==='trip') trips.set(it.id,it.attributes); if(it.type==='route') routes.set(it.id,it.attributes); });
      const cand=(json.data||[]).filter(r=>r.attributes?.departure_time).map(r=>{ const tripId=r.relationships?.trip?.data?.id; const routeId2=r.relationships?.route?.data?.id; const trip=trips.get(tripId)||{}; return { fromStop: stopId, trip_id: tripId, route: routes.get(routeId2)?.long_name || routeId2 || '-', headsign: trip.headsign || '-', departure_time: r.attributes.departure_time, direction_id: trip.direction_id }; }).filter(o=>/north station/i.test(o.headsign||''));
      if(cand.length){ rows=cand; break; }
    }
    return rows;
  }
  async function fetchNorthArrivals(tripIds){ if(!tripIds.length) return {}; const ids=tripIds.slice(0,50).join(','); const j=await api(`/schedules?filter[trip]=${ids}&filter[stop]=place-north&page[limit]=300`); const map={}; (j.data||[]).forEach(r=>{ const tid=r.relationships?.trip?.data?.id; map[tid]=r.attributes?.arrival_time||r.attributes?.departure_time||null; }); return map; }

  function toNY(d){ return new Date(new Date(d).toLocaleString('en-US',{timeZone:'America/New_York'})); }
  function hhmmNY(iso){ if(!iso) return '-'; const dt=toNY(iso); return `${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}`; }

  async function refreshNext3(){
    try{
      const [wmStop, porterStop] = await Promise.all([
        findStopIdForRoute('CR-Lowell', ['West Medford']),
        findStopIdForRoute('CR-Fitchburg', ['Porter','Porter Square'])
      ]);
      const [wmRowsAll, porterRowsAll] = await Promise.all([
        fetchInboundRows(wmStop, 'CR-Lowell'),
        fetchInboundRows(porterStop, 'CR-Fitchburg')
      ]);

      const now = nyToday();
      const wmUpcoming = wmRowsAll.filter(r=> toNY(r.departure_time) >= now)
                                  .sort((a,b)=> new Date(a.departure_time) - new Date(b.departure_time))
                                  .slice(0,3);
      const porterUpcoming = porterRowsAll.filter(r=> toNY(r.departure_time) >= now)
                                          .sort((a,b)=> new Date(a.departure_time) - new Date(b.departure_time))
                                          .slice(0,3);

      const needTrips = [...wmUpcoming, ...porterUpcoming].map(r=> r.trip_id);
      const arrMap = await fetchNorthArrivals(needTrips);

      const box = document.getElementById('next3');
      const renderSet = (title, rows, routeLabel, stationLabel)=>{
        if(!rows.length){
          return `<div class="small" style="margin-top:6px"><strong>${title}</strong>: No upcoming trains.</div>`;
        }
        const list = rows.map(r=>{
          const arr = arrMap[r.trip_id];
          return `<div class="train lh">
            <div class="small">${stationLabel}</div>
            <div>
              <div><strong>${hhmmNY(r.departure_time)}</strong> → North Station ${arr?`<span class="small">(arr ${hhmmNY(arr)})</span>`:''}</div>
              <div class="small">${r.route} — ${r.headsign}</div>
            </div>
            <div class="route">${routeLabel}</div>
          </div>`;}).join('');
        return `<div style="margin-top:6px"><div class="label" style="margin:4px 0 8px"><strong>${title}</strong></div>${list}</div>`;
      };

      box.innerHTML = [
        renderSet('Lowell Line (West Medford → North Station)', wmUpcoming, 'Lowell', 'West Medford'),
        renderSet('Fitchburg Line (Porter → North Station)', porterUpcoming, 'Fitchburg', 'Porter')
      ].join('');
    }catch(e){
      console.error(e);
      document.getElementById('next3').innerHTML = `<div class="small bad">Failed to load trains: ${e.message||e}</div>`;
    }
  }

  // --- simplified per-line tables (3 each) with countdown ---
  function renderTable(title, rows){
    const head = `<div class="label" style="margin:6px 0 8px"><strong>${title}</strong></div>`;
    if(!rows || !rows.length){ return head + `<div class="small">No upcoming trains.</div>`; }
    const trs = rows.map(r=>`<tr>
        <td style="padding:6px 8px">${hhmmNY(r.departure_time)}</td>
        <td style="padding:6px 8px"><span class="cd" data-dep="${r.departure_time}"></span></td>
      </tr>`).join('');
    return head + `<table class="small" style="width:100%; border-collapse:collapse">
      <thead><tr><th style="text-align:left; padding:6px 8px">Departure</th><th style="text-align:left; padding:6px 8px">In</th></tr></thead>
      <tbody>${trs}</tbody></table>`;
  }

  function updateCountdowns(){
    const els = document.querySelectorAll('#next3 .cd');
    const now = new Date(new Date().toLocaleString('en-US',{timeZone:'America/New_York'}));
    els.forEach(el=>{
      const iso = el.getAttribute('data-dep');
      if(!iso){ el.textContent='-'; return; }
      const dep = new Date(new Date(iso).toLocaleString('en-US',{timeZone:'America/New_York'}));
      const diffMs = dep - now;
      if(diffMs <= 0){ el.textContent = 'now'; el.className='cd gray'; return; }
      const min = Math.floor(diffMs/60000);
      el.textContent = `${min}m`;

      // ★ ここで色分け
      if(min <= 10){ el.className='cd gray'; }
      else if(min <= 15){ el.className='cd red'; }
      else if(min <= 20){ el.className='cd yellow'; }
      else { el.className='cd white'; }
    });
  }


  async function refreshNext3_v2(){
    try{
      const [wmStop, porterStop] = await Promise.all([
        findStopIdForRoute('CR-Lowell', ['West Medford']),
        findStopIdForRoute('CR-Fitchburg', ['Porter','Porter Square'])
      ]);
      const [wmRowsAll, porterRowsAll] = await Promise.all([
        fetchInboundRows(wmStop, 'CR-Lowell'),
        fetchInboundRows(porterStop, 'CR-Fitchburg')
      ]);

      const now = nyToday();
      const wmUpcoming = wmRowsAll
        .filter(r=> new Date(new Date(r.departure_time).toLocaleString('en-US',{timeZone:'America/New_York'})) >= now)
        .sort((a,b)=> new Date(a.departure_time) - new Date(b.departure_time))
        .slice(0,3);
      const porterUpcoming = porterRowsAll
        .filter(r=> new Date(new Date(r.departure_time).toLocaleString('en-US',{timeZone:'America/New_York'})) >= now)
        .sort((a,b)=> new Date(a.departure_time) - new Date(b.departure_time))
        .slice(0,3);

      const box = document.getElementById('next3');
      box.innerHTML = [
        renderTable('Lowell Line (West Medford)', wmUpcoming),
        renderTable('Fitchburg Line (Porter)', porterUpcoming)
      ].join('');

      updateCountdowns();
    }catch(e){
      console.error(e);
      document.getElementById('next3').innerHTML = `<div class="small bad">Failed to load trains: ${e.message||e}</div>`;
    }
  }

  refreshNext3_v2();
  setInterval(refreshNext3_v2, 60*1000);   // 1分ごとに再取得
  setInterval(updateCountdowns, 1000);     // 毎秒カウントダウン更新

</script>
</body>
</html>
